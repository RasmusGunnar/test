<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Familieoversigt – autosync</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%230f172a'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' fill='white' font-family='Arial'%3EF%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#f6f7fb;--panel:#fff;--ink:#0f172a;--muted:#475569;--shadow:0 8px 30px rgba(2,6,23,.08);--radius:18px;--edge:clamp(8px,2vw,20px);--gap:clamp(6px,1.2vw,14px);--done:#ecfdf5}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;font:16px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--ink);background:var(--bg)}
    .wrap{max-width:100vw;margin:0 auto;padding:var(--edge)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .title{font-size:22px;font-weight:800}.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hid{font-weight:800;font-size:12px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#334155;border:1px solid #e5e7eb}
    .btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700;color:#0f172a;box-shadow:0 2px 6px rgba(2,6,23,.05)}
    .btn.primary{background:#0f172a;color:#fff;border-color:transparent}.btn.icon{width:36px;height:36px;display:grid;place-items:center;padding:0}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}.btn.ghost{background:#fff;border:1px solid #e5e7eb}
    .chipbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .chip{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid #e5e7eb;color:#334155;font-weight:700;border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#0f172a;color:#fff;border-color:transparent}.avatar{width:22px;height:22px;border-radius:999px;object-fit:cover}
    .grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:var(--gap)}
    .day{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px 10px 14px;min-height:42vh;display:flex;flex-direction:column}
    .head{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px}.name{font-weight:800}.date{color:#475569;font-size:12px;font-weight:700}.today{outline:2px solid #11182722}
    .list{display:flex;flex-direction:column;gap:6px;margin-top:6px;flex:1;min-height:100px}.section{margin-top:6px}
    .section .h{font-size:11px;font-weight:900;color:#94a3b8;text-transform:uppercase;letter-spacing:.06em;margin:6px 0 2px}
    .items{display:flex;flex-direction:column;gap:6px}
    .item{background:#fff;border:1px solid #e5e7eb;border-left:6px solid #64748b;border-radius:12px;padding:8px 10px;display:flex;gap:8px;align-items:flex-start;box-shadow:0 4px 14px rgba(2,6,23,.06);cursor:pointer}
    .item .left{display:flex;align-items:center;justify-content:center;min-width:52px;font-weight:800;color:#0f172a}.meta{display:flex;flex-direction:column;gap:2px;min-width:0;flex:1}
    .titlex{font-weight:800;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.note{color:#475569;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .done{background:var(--done)}.done .titlex{text-decoration:line-through}
    .floating{position:fixed;right:16px;bottom:16px;display:flex;gap:8px;z-index:999;flex-wrap:wrap;justify-content:flex-end}
    .badge{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px 12px;font-weight:700;color:#334155;box-shadow:var(--shadow)}
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,.28);display:none;align-items:flex-start;justify-content:center;padding:32px;z-index:2000}
    .modal{width:min(860px,92vw);max-height:min(92vh,92dvh);overflow:auto;background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px 16px 12px}
    .modal h3{margin:0 0 10px;font-size:18px;font-weight:800}.form{display:grid;grid-template-columns:1fr 1fr;gap:10px}.full{grid-column:1/-1}
    label{display:block;font-size:12px;font-weight:800;color:#334155;margin-bottom:6px}
    input,textarea,select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font:inherit;background:#fff}textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:12px;align-items:center}.row label{margin:0;font-weight:700}
    .settings{width:min(860px,92vw);max-height:min(92vh,92dvh);overflow:auto;background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .row-s{display:grid;grid-template-columns:44px 1fr 1fr 64px 32px;gap:12px;align-items:center;padding:8px;border:1px solid #e5e7eb;border-radius:12px;margin-bottom:8px}
    .initial{width:36px;height:36px;border-radius:999px;display:grid;place-items:center;background:#eef2ff;font-weight:800}.swatch{width:14px;height:14px;border-radius:999px;border:1px solid #e5e7eb;justify-self:end}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:640px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Familieoversigt · uge <span id="weekNo">?</span></div>
      <div class="controls">
        <span id="hidPill" class="hid">HID: —</span>
        <button class="btn icon" id="prev">⟨</button>
        <button class="btn" id="weekBtn">—</button>
        <button class="btn icon" id="next">⟩</button>
        <button class="btn primary" id="newBtn">+ Ny</button>
        <button class="btn" id="settingsBtn">Indstillinger</button>
      </div>
    </header>

    <div id="peopleBar" class="chipbar"></div>
    <section id="grid" class="grid"></section>
  </div>

  <div class="floating">
    <div id="gBadge" class="badge">Google sync: —</div>
    <button class="btn small" id="gSync">Sync nu</button>
    <button class="btn small ghost" id="gReset">Nulstil &amp; sync</button>
  </div>

  <!-- Editor -->
  <div id="editorBD" class="backdrop" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 id="dlgTitle">Tilføj</h3>
        <button class="btn ghost" id="dlgClose">Luk</button>
      </div>
      <div class="form">
        <div class="full"><label for="f_title">Titel</label><input id="f_title" type="text" placeholder="Titel"></div>
        <div><label for="f_type">Type</label><select id="f_type"><option>Aktivitet</option><option>Opgave</option><option>Fritidsinteresse</option></select></div>
        <div><label for="f_person">Person</label><select id="f_person"><option>Alle</option></select></div>
        <div><label for="f_date">Dato</label><input id="f_date" type="date"></div>
        <div><label for="f_time">Tid</label><input id="f_time" type="time" step="900" placeholder="--:--"></div>
        <div><label for="f_dur">Varighed (min)</label><input id="f_dur" type="number" min="0" step="5" placeholder="30"></div>
        <div><label for="f_loc">Sted</label><input id="f_loc" type="text" placeholder="Adresse/sted"></div>
        <div class="full"><label for="f_note">Note</label><textarea id="f_note" placeholder="Noter"></textarea></div>
        <div class="full row"><input id="f_rep" type="checkbox"><label for="f_rep">Gentag hver uge</label><input id="f_done" type="checkbox" style="margin-left:16px"><label for="f_done">Marker som udført</label></div>
      </div>
      <div class="actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button class="btn ghost" id="btnDel" style="display:none">Slet</button>
        <button class="btn primary" id="btnSave">Gem</button>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settBD" class="backdrop">
    <div class="settings">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Indstillinger · Familie</h3>
        <button class="btn ghost" id="settClose">Luk</button>
      </div>
      <div id="settRows"></div>
      <div class="tip">Billeder gemmes lokalt. Farver/avatars synkes via Firestore til alle enheder.</div>
      <div class="actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button class="btn primary" id="settSave">Gem ændringer</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- core utils ---------- */
    const HID=(new URLSearchParams(location.search).get("hid")||"DEFAULT").toUpperCase();
    document.getElementById("hidPill").textContent="HID: "+HID;

    const LS_ITEMS="fam_items_v1", LS_PREFS="fam_people_prefs_v1", LS_GIDX="gcal_index";
    const DEFAULT_PEOPLE=[{name:"Alle",color:"#0f172a"},{name:"Far",color:"#ef4444"},{name:"Mor",color:"#8b5cf6"},{name:"Carl",color:"#22c55e"},{name:"Jakob",color:"#0ea5e9"},{name:"Ida",color:"#f59e0b"}];

    const $ = (id)=>document.getElementById(id);
    const grid = $("grid"), peopleBar = $("peopleBar"), weekNo = $("weekNo"), weekBtn = $("weekBtn");
    const gBadge=$("gBadge");

    function fmtISO(d){return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")}
    function fromAnyToLocalISO(x){
      if(!x) return fmtISO(new Date());
      if(/^\d{4}-\d{2}-\d{2}$/.test(x)) return x;                      // "YYYY-MM-DD"
      const t=new Date(x);                                             // handles Z/offsets
      return fmtISO(new Date(t.getFullYear(),t.getMonth(),t.getDate())); // strip time -> local
    }
    function startOfWeek(d=new Date()){const n=(d.getDay()+6)%7;const m=new Date(d);m.setDate(d.getDate()-n);m.setHours(0,0,0,0);return m}
    function weekNumber(d){d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const dn=d.getUTCDay()||7;d.setUTCDate(d.getUTCDate()+4-dn);const ys=new Date(Date.UTC(d.getUTCFullYear(),0,1));return Math.ceil((((d-ys)/86400000)+1)/7)}
    function monthName(m){return["januar","februar","marts","april","maj","juni","juli","august","september","oktober","november","december"][m]}
    function weekLabel(s){const e=new Date(s);e.setDate(s.getDate()+6);return s.getMonth()===e.getMonth()?`${s.getDate()}.–${e.getDate()}. ${monthName(e.getMonth())}`:`${s.getDate()}. ${monthName(s.getMonth())} – ${e.getDate()}. ${monthName(e.getMonth())}`}

    function loadLS(k,fallback){try{const v=localStorage.getItem(k);return v?JSON.parse(v):fallback}catch(_){return fallback}}
    function saveLS(k,v){localStorage.setItem(k,JSON.stringify(v))}
    function normalizeType(t){if(t==="Anden aftale"||t==="Andre aftaler")return"Aktivitet";if(t==="Fritidsinteresser")return"Fritidsinteresse";return t||"Aktivitet"}

    function keyOf(it){return[(it.title||"").trim().toLowerCase(),(it.date||"").trim(),(it.time||"").trim(),(it.person||"Alle").trim(),(it.type||"Aktivitet").trim()].join("|")}
    function djb2(s){let h=5381;for(let i=0;i<s.length;i++)h=((h<<5)+h)^s.charCodeAt(i);return (h>>>0).toString(36)}
    function uidFor(it){
      const date = it.date||"";
      if(it.id && it.id.startsWith("gcal:")) return "g:"+it.id.slice(5)+"|"+date;     // id fra GAS, per forekomst
      if(it.id && it.id.startsWith("gcalr:"))return "gr:"+it.id.slice(6);             // hvis du senere bruger ugentlige ankre
      if(it.source==="google") return "g:"+(it.id||djb2(keyOf(it)))+"|"+date;
      return "l:"+djb2(keyOf(it));                                                    // lokale
    }

    /* ---------- state ---------- */
    let PEOPLE, items, current="Alle", editId=null, wk=startOfWeek();
    function loadPrefs(){return loadLS(LS_PREFS,{});}
    function savePrefs(p){saveLS(LS_PREFS,p)}
    function getPeople(){const p=loadPrefs();return DEFAULT_PEOPLE.map(x=>({...x,color:p[x.name]?.color||x.color,avatar:p[x.name]?.avatar||""}))}
    function loadItems(){const arr=loadLS(LS_ITEMS,[]).map(it=>({...it,type:normalizeType(it.type),person:it.person||"Alle"}));saveLS(LS_ITEMS,arr);return arr}
    function saveItems(){saveLS(LS_ITEMS,items)}

    PEOPLE=getPeople(); items=loadItems();

    function personColor(n){const p=PEOPLE.find(x=>x.name===n);return p?p.color:"#64748b"}
    function personAvatar(n){const p=PEOPLE.find(x=>x.name===n);return p?.avatar||""}

    function buildPeople(){
      peopleBar.innerHTML="";
      for(const p of PEOPLE){
        const b=document.createElement("button");
        b.className="chip"+(p.name===current?" active":"");
        b.style.borderColor=p.name!=="Alle"?personColor(p.name):"";
        const media=p.name!=="Alle"&&personAvatar(p.name)?`<img class="avatar" src="${personAvatar(p.name)}" alt="">`:`<span class="avatar" style="background:${personColor(p.name)}22;display:grid;place-items:center;font-weight:800;color:#111">${p.name[0]}</span>`;
        b.innerHTML=`${media}<span>${p.name}</span>`;
        b.onclick=()=>{current=p.name;buildPeople();render()};
        peopleBar.appendChild(b);
      }
    }
    function buildGrid(){
      grid.innerHTML="";
      const names=["mandag","tirsdag","onsdag","torsdag","fredag","lørdag","søndag"];
      for(let i=0;i<7;i++){
        const d=new Date(wk);d.setDate(wk.getDate()+i);const iso=fmtISO(d);
        const card=document.createElement("div");card.className="day"+(fmtISO(new Date())===iso?" today":"");card.dataset.date=iso;
        const head=`<div class="head"><div class="name">${names[i]}</div><div class="date">${String(d.getDate()).padStart(2,"0")+". "+String(d.getMonth()+1).padStart(2,"0")+"."}</div></div>`;
        const body=`<div class="list">
          <div class="section" data-section="Aktivitet"><div class="h">Aktiviteter</div><div class="items"></div></div>
          <div class="section" data-section="Fritidsinteresse"><div class="h">Fritidsinteresser</div><div class="items"></div></div>
          <div class="section" data-section="Opgave"><div class="h">Opgaver</div><div class="items"></div></div>
        </div>`;
        card.innerHTML=head+body;grid.appendChild(card);
      }
    }
    function withinWeek(iso){const [Y,M,D]=iso.split("-").map(Number);const d=new Date(Y,M-1,D);const e=new Date(wk);e.setDate(wk.getDate()+7);return d>=wk && d<e}

    function baseId(any){if(!any)return any;if(any.startsWith("rpt|"))return any.split("|")[1];if(any.startsWith("rpt:"))return any.split(":")[1];return any}
    function getByAnyId(id){const b=baseId(id);return items.find(x=>x.id===b)||null}

    function render(){
      weekNo.textContent=weekNumber(wk); weekBtn.textContent=weekLabel(wk); buildGrid();

      const visible=items
        .filter(it=>withinWeek(it.date))
        .filter(it=>current==="Alle"||it.person===current)
        .sort((a,b)=>a.date.localeCompare(b.date)||(a.time||"").localeCompare(b.time||""));

      const seen=new Set();
      for(const it of visible){
        const UID=uidFor(it); if(seen.has(UID)) continue; seen.add(UID);
        const day=document.querySelector(`.day[data-date="${it.date}"]`); if(!day) continue;
        const sec=day.querySelector(`.section[data-section="${normalizeType(it.type)}"] .items`); if(!sec) continue;
        const left = (it.type==="Opgave") ? `<input type="checkbox" ${it.done?'checked':''} data-opg="${it.id}">` : (it.time||'<span class="muted">Heldag</span>');
        const div=document.createElement("div");
        div.className="item"+(it.done?" done":""); div.style.borderLeftColor=personColor(it.person); div.dataset.id=it.id;
        div.innerHTML=`<div class="left">${left}</div><div class="meta"><div class="titlex">${(it.title||"(uden titel)").replace(/[&<>]/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s]))}${it.repeatWeekly?' · <span class="muted">↻ uge</span>':''}</div>${it.location?`<div class="note">${it.location}</div>`:""}${it.note?`<div class="note">${it.note}</div>`:""}</div>`;
        div.onclick=(e)=>{if(e.target && e.target.matches('input[type="checkbox"]'))return; openEditor(div.dataset.id)}
        sec.appendChild(div);
      }

      document.querySelectorAll('input[data-opg]').forEach(cb=>{
        cb.addEventListener("change",e=>{const any=e.target.getAttribute("data-opg");const it=getByAnyId(any);if(!it)return;it.done=e.target.checked; upsert(it)})
      })
    }

    function upsert(obj){
      obj.type=normalizeType(obj.type); if(!obj.person)obj.person="Alle";
      const UID=uidFor(obj);           // why: stabil identitet
      const i=items.findIndex(x=>uidFor(x)===UID);
      if(i>=0) items[i]={...items[i],...obj}; else items.push(obj);
      saveItems(); render();
    }
    function remove(id){items=items.filter(x=>x.id!==id);saveItems();render()}

    // editor
    const EBD=$("editorBD"), DTitle=$("dlgTitle"), Ftitle=$("f_title"), Ftype=$("f_type"), Fperson=$("f_person"), Fdate=$("f_date"), Ftime=$("f_time"), Fdur=$("f_dur"), Floc=$("f_loc"), Fnote=$("f_note"), Frep=$("f_rep"), Fdone=$("f_done");
    function fillPeopleSelect(){Fperson.innerHTML=PEOPLE.map(p=>`<option${p.name==="Alle"?" selected":""}>${p.name}</option>`).join("")}
    function openNew(dateISO){editId=null;DTitle.textContent="Tilføj";Ftitle.value="";Ftype.value="Aktivitet";Fperson.value="Alle";Fdate.value=dateISO||fmtISO(new Date());Ftime.value="";Fdur.value="";Floc.value="";Fnote.value="";Frep.checked=false;Fdone.checked=false;$("btnDel").style.display="none";EBD.style.display="flex"}
    function openEditor(any){const b=getByAnyId(any);if(!b)return;editId=b.id;DTitle.textContent="Rediger";Ftitle.value=b.title||"";Ftype.value=normalizeType(b.type);Fperson.value=b.person||"Alle";Fdate.value=b.date||fmtISO(new Date());Ftime.value=b.time||"";Fdur.value=b.durationMin||"";Floc.value=b.location||"";Fnote.value=b.note||"";Frep.checked=!!b.repeatWeekly;Fdone.checked=!!b.done;$("btnDel").style.display="inline-flex";EBD.style.display="flex"}
    $("dlgClose").onclick=()=>EBD.style.display="none";
    $("btnDel").onclick=()=>{if(editId){remove(editId);EBD.style.display="none"}}
    $("btnSave").onclick=()=>{const o={id:editId||("loc:"+Date.now().toString(36)+Math.random().toString(36).slice(2)),title:(Ftitle.value||"(uden titel)").trim(),type:normalizeType(Ftype.value),person:Fperson.value||"Alle",date:Fdate.value,time:Ftime.value||"",durationMin:Fdur.value?parseInt(Fdur.value,10):0,location:(Floc.value||"").trim(),note:(Fnote.value||"").trim(),repeatWeekly:!!Frep.checked,done:!!Fdone.checked,source: editId&&String(editId).startsWith("gcal")?"google":"local"}; upsert(o);EBD.style.display="none"}

    // header buttons
    $("prev").onclick=()=>{wk.setDate(wk.getDate()-7);render()}
    $("next").onclick=()=>{wk.setDate(wk.getDate()+7);render()}
    weekBtn.onclick=()=>{wk=startOfWeek(new Date());render()}
    $("newBtn").onclick=()=>openNew()
    $("settingsBtn").onclick=()=>{buildSettings();$("settBD").style.display="flex"}
    $("settClose").onclick=()=>{$("settBD").style.display="none"}

    // settings (synk farver/avatars)
    function buildSettings(){const box=$("settRows");box.innerHTML="";for(const p of PEOPLE){const row=document.createElement("div");row.className="row-s";row.innerHTML=`<div class="initial">${(p.name[0]||"?").toUpperCase()}</div><input type="text" value="${p.name}" data-f="name" data-for="${p.name}"><input type="file" accept="image/*" data-f="avatar" data-for="${p.name}"><input type="color" value="${p.color}" data-f="color" data-for="${p.name}"><span class="swatch" style="background:${p.color}"></span>`;row.querySelector('input[type="color"]').addEventListener("input",e=>row.querySelector(".swatch").style.background=e.target.value);box.appendChild(row)}}
    $("settSave").onclick=()=>{const prefs=loadPrefs();document.querySelectorAll("#settRows .row-s").forEach(r=>{const old=r.querySelector('input[data-f="name"]').getAttribute("data-for");const name=r.querySelector('input[data-f="name"]').value.trim()||old;const color=r.querySelector('input[data-f="color"]').value;const fi=r.querySelector('input[data-f="avatar"]');const prev=prefs[old]?.avatar||"";prefs[name]={color,avatar:prev};if(fi.files&&fi.files[0]){const fr=new FileReader();fr.onload=()=>{prefs[name]={color,avatar:fr.result};savePrefs(prefs);if(window._peopleFS?.save)window._peopleFS.save(prefs);refreshPeople()};fr.readAsDataURL(fi.files[0])}});savePrefs(prefs);if(window._peopleFS?.save)window._peopleFS.save(prefs);refreshPeople();$("settBD").style.display="none"}
    function refreshPeople(){PEOPLE=getPeople();fillPeopleSelect();buildPeople();render()}

    /* ---------- Google sync (enkeltforekomster) ---------- */
    const GAS_URL="https://script.google.com/macros/s/AKfycbyQeS_NvMVv4A3IImB6S3AsRt67aSpeKuaoHHSf8K4xRE9sx3zSZS8zHlvZFL_WDIKl/exec";
    function loadGIdx(){return loadLS(LS_GIDX,{})}function saveGIdx(x){saveLS(LS_GIDX,x)}
    function setBadge(t){gBadge.textContent="Google sync: "+t}
    async function fetchEvents(){const u=GAS_URL+(GAS_URL.includes("?")?"&":"?")+"t="+Date.now();const r=await fetch(u,{cache:"no-store"});if(!r.ok)throw new Error("GAS "+r.status);const j=await r.json();return Array.isArray(j.items)?j.items:[]}
    async function syncNow(){try{setBadge("henter…");const evs=await fetchEvents();const idx=loadGIdx();let created=0;for(const ev of evs){const date=fromAnyToLocalISO(ev.startISO||ev.date);const id="gcal:"+ev.id;const item={id,title:ev.summary||"(uden titel)",type:"Aktivitet",person:"Alle",date,time:ev.time||"",durationMin:ev.durationMin||30,location:ev.location||"",note:ev.description||"",repeatWeekly:false,done:false,source:"google"};const uid=uidFor(item);if(idx[uid]===ev.updated)continue; upsert(item);idx[uid]=ev.updated;created++}saveGIdx(idx);setBadge(created?`+${created} oprettet`:"ingen ændringer")}catch(e){console.error(e);setBadge("fejl")}}
    $("gSync").onclick=()=>syncNow()
    $("gReset").onclick=()=>{localStorage.removeItem(LS_GIDX);setBadge("nulstiller…");syncNow()}

    /* ---------- Firestore bridges ---------- */
  </script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script>
    (function(){
      const cfg={apiKey:"AIzaSyA_gh8y-V6kkl95hRzb0ldBxpKWFY5bAck",authDomain:"webkiosk-e5d32.firebaseapp.com",projectId:"webkiosk-e5d32",storageBucket:"webkiosk-e5d32.firebasestorage.app",messagingSenderId:"920175197353",appId:"1:920175197353:web:c3520e9a3ab8146ec4fdb8"};
      if(!firebase.apps.length)firebase.initializeApp(cfg);
      const auth=firebase.auth(),db=firebase.firestore();

      const col=db.collection("households").doc(HID).collection("calendar").doc("v1").collection("items");

      function canon(v,id){
        const d=(v&&v.data&&typeof v.data==="object")?v.data:v||{};
        const out={ id:(d.id||v.id||("fs:"+id)), title:d.title||(v.title)||"(uden titel)", type:normalizeType(d.type||v.type), person:(d.person||v.person)||"Alle",
          date:fromAnyToLocalISO(d.date||v.date||""), time:(d.time||v.time)||"", durationMin: Number.isFinite(d.durationMin)?d.durationMin:(v.durationMin||0),
          location:d.location||v.location||"", note:d.note||v.note||"", repeatWeekly:!!(d.repeatWeekly||v.repeatWeekly), done:!!(d.done||v.done), source:d.source||v.source||"fs" };
        return out;
      }

      async function migrateSnapshot(snap){
        const b=db.batch(); let changed=false; const seen=new Set();
        snap.forEach(doc=>{
          const dat=canon(doc.data(),doc.id); const uid=uidFor(dat);
          if(doc.id!==uid){ b.set(col.doc(uid),{data:dat,uid, title:dat.title,date:dat.date,time:dat.time,person:dat.person,type:dat.type,note:dat.note,done:dat.done,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); b.delete(col.doc(doc.id)); changed=true; }
          else { b.set(col.doc(uid),{uid, data:dat, title:dat.title,date:dat.date,time:dat.time,person:dat.person,type:dat.type,note:dat.note,done:dat.done,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); changed=true; }
          if(seen.has(uid)){ b.delete(col.doc(doc.id)); changed=true; } else seen.add(uid);
        });
        if(changed) await b.commit();
      }

      async function pushAll(localArr){
        try{
          const b=db.batch(); const seen=new Set();
          for(const it of localArr){
            const data={...it,type:normalizeType(it.type),date:fromAnyToLocalISO(it.date)};
            const uid=uidFor(data); if(seen.has(uid)) continue; seen.add(uid);
            b.set(col.doc(uid),{uid, data, title:data.title,date:data.date,time:data.time,person:data.person,type:data.type,note:data.note,done:!!data.done,createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
          }
          await b.commit();
        }catch(e){console.error("[FS push]",e)}
      }

      function writeAndRender(arr){ saveLS(LS_ITEMS,arr); try{ render() }catch(_){ } }

      // people prefs sync
      const prefsDoc=db.collection("households").doc(HID).collection("prefs").doc("people_v1");
      async function ensurePrefs(){
        const d=await prefsDoc.get(); if(!d.exists){ const base={}; for(const p of DEFAULT_PEOPLE) base[p.name]={color:p.color,avatar:""}; await prefsDoc.set({people:base,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}) }
        prefsDoc.onSnapshot(s=>{ if(s.exists){ const map=s.data().people||{}; saveLS(LS_PREFS,map); refreshPeople() } })
      }
      window._peopleFS={ save:async(p)=>{try{await prefsDoc.set({people:p,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true})}catch(e){console.error("[prefs save]",e)}} };

      auth.signInAnonymously().then(async ()=>{
        await ensurePrefs();

        const local=loadLS(LS_ITEMS,[]);
        const snap=await col.get();
        if(local.length && snap.empty){ await pushAll(local) }
        else if(!local.length && !snap.empty){
          await migrateSnapshot(snap);
          const s2=await col.get(); const map=new Map();
          s2.forEach(d=>{const it=canon(d.data(),d.id); map.set(uidFor(it),it)});
          writeAndRender([...map.values()]);
        }

        col.onSnapshot(async s=>{
          await migrateSnapshot(s);
          const fresh=await col.get(); const map=new Map();
          fresh.forEach(d=>{const it=canon(d.data(),d.id); map.set(uidFor(it),it)});
          writeAndRender([...map.values()]);
        });

        // når lokale ændres → skub til FS (debounce)
        let t=null; const origSet=localStorage.setItem.bind(localStorage);
        localStorage.setItem=function(k,v){const r=origSet(k,v); if(k===LS_ITEMS){ clearTimeout(t); t=setTimeout(()=>{ try{pushAll(JSON.parse(v)||[])}catch(_){}} ,300);} return r; };
      }).catch(e=>console.error("[auth]",e));
    })();
  </script>

  <script>
    // bootstrap UI
    fillPeopleSelect(); buildPeople(); render(); syncNow(); setInterval(syncNow, 120000);
    grid.addEventListener("dblclick",e=>{const day=e.target.closest(".day"); if(day) openNew(day.dataset.date)});
  </script>
</body>
</html>
