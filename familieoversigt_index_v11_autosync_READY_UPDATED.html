<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Familieoversigt â€“ autosync</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%230f172a'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' fill='white' font-family='Arial'%3EF%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#f6f7fb;--panel:#fff;--ink:#0f172a;--muted:#475569;--shadow:0 8px 30px rgba(2,6,23,.08);--radius:18px;--edge:clamp(8px,2vw,20px);--gap:clamp(6px,1.2vw,14px);--done:#ecfdf5}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;font:16px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--ink);background:var(--bg)}
    .wrap{max-width:100vw;margin:0 auto;padding:var(--edge)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .title{font-size:22px;font-weight:800}.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hid{font-weight:800;font-size:12px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#334155;border:1px solid #e5e7eb}
    .btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700;color:#0f172a;box-shadow:0 2px 6px rgba(2,6,23,.05)}
    .btn.primary{background:#0f172a;color:#fff;border-color:transparent}.btn.icon{width:36px;height:36px;display:grid;place-items:center;padding:0}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}.btn.ghost{background:#fff;border:1px solid #e5e7eb}
    .chipbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .chip{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid #e5e7eb;color:#334155;font-weight:700;border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip .tally{font-size:18px;line-height:1;letter-spacing:2px}
    .chip.active{background:#0f172a;color:#fff;border-color:transparent}.avatar{width:22px;height:22px;border-radius:999px;object-fit:cover}
    .grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:var(--gap)}
    .day{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px 10px 14px;min-height:42vh;display:flex;flex-direction:column}
    .head{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px}.name{font-weight:800}.date{color:#475569;font-size:12px;font-weight:700}.today{outline:2px solid #11182722}
    .list{display:flex;flex-direction:column;gap:6px;margin-top:6px;flex:1;min-height:100px}.section{margin-top:6px}
    .section .h{font-size:11px;font-weight:900;color:#94a3b8;text-transform:uppercase;letter-spacing:.06em;margin:6px 0 2px}
    .items{display:flex;flex-direction:column;gap:6px}
    .item{background:#fff;border:1px solid #e5e7eb;border-left:6px solid #64748b;border-radius:12px;padding:8px 10px;display:flex;gap:8px;align-items:flex-start;box-shadow:0 4px 14px rgba(2,6,23,.06);cursor:pointer}
    .item .left{display:flex;align-items:center;justify-content:center;min-width:52px;font-weight:800;color:#0f172a}.meta{display:flex;flex-direction:column;gap:2px;min-width:0;flex:1}
    .titlex{font-weight:800;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.note{color:#475569;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .done{background:var(--done)}.done .titlex{text-decoration:line-through}
    .floating{position:fixed;right:16px;bottom:16px;display:flex;gap:8px;z-index:999;flex-wrap:wrap;justify-content:flex-end}
    .badge{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px 12px;font-weight:700;color:#334155;box-shadow:var(--shadow)}
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,.28);display:none;align-items:flex-start;justify-content:center;padding:32px;z-index:2000}
    .modal{width:min(860px,92vw);max-height:min(92vh,92dvh);overflow:auto;background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px 16px 12px}
    .modal h3{margin:0 0 10px;font-size:18px;font-weight:800}.form{display:grid;grid-template-columns:1fr 1fr;gap:10px}.full{grid-column:1/-1}
    label{display:block;font-size:12px;font-weight:800;color:#334155;margin-bottom:6px}
    input,textarea,select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font:inherit;background:#fff}textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:12px;align-items:center}.row label{margin:0;font-weight:700}
    .settings{width:min(860px,92vw);max-height:min(92vh,92dvh);overflow:auto;background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .row-s{display:grid;grid-template-columns:44px 1fr 1fr 64px 32px;gap:12px;align-items:center;padding:8px;border:1px solid #e5e7eb;border-radius:12px;margin-bottom:8px}
    .initial{width:36px;height:36px;border-radius:999px;display:grid;place-items:center;background:#eef2ff;font-weight:800}.swatch{width:14px;height:14px;border-radius:999px;border:1px solid #e5e7eb;justify-self:end}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:640px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Familieoversigt Â· uge <span id="weekNo">?</span></div>
      <div class="controls">
        <span id="hidPill" class="hid">HID: â€”</span>
        <button class="btn icon" id="prev">âŸ¨</button>
        <button class="btn" id="weekBtn">â€”</button>
        <button class="btn icon" id="next">âŸ©</button>
        <button class="btn primary" id="newBtn">+ Ny</button>
        <button class="btn" id="settingsBtn">Indstillinger</button>
      </div>
    </header>

    <div id="peopleBar" class="chipbar"></div>
    <section id="grid" class="grid"></section>
  </div>

  <div class="floating">
    <div id="gBadge" class="badge">Google sync: â€”</div>
    <button class="btn small" id="gSync">Sync nu</button>
    <button class="btn small ghost" id="gReset">Nulstil &amp; sync</button>
  </div>

  <!-- Editor -->
  <div id="editorBD" class="backdrop" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 id="dlgTitle">TilfÃ¸j</h3>
        <button class="btn ghost" id="dlgClose">Luk</button>
      </div>
      <div class="form">
        <div class="full"><label for="f_title">Titel</label><input id="f_title" type="text" placeholder="Titel"></div>
        <div><label for="f_type">Type</label><select id="f_type"><option>Aktivitet</option><option>Opgave</option><option>Fritidsinteresse</option></select></div>
        <div><label for="f_person">Person</label><select id="f_person"><option>Alle</option></select></div>
        <div><label for="f_date">Dato</label><input id="f_date" type="date"></div>
        <div><label for="f_time">Tid</label><input id="f_time" type="time" step="900" placeholder="--:--"></div>
        <div><label for="f_dur">Varighed (min)</label><input id="f_dur" type="number" min="0" step="5" placeholder="30"></div>
        <div><label for="f_loc">Sted</label><input id="f_loc" type="text" placeholder="Adresse/sted"></div>
        <div class="full"><label for="f_note">Note</label><textarea id="f_note" placeholder="Noter"></textarea></div>
        <div class="full row"><input id="f_rep" type="checkbox"><label for="f_rep">Gentag hver uge</label><input id="f_done" type="checkbox" style="margin-left:16px"><label for="f_done">Marker som udfÃ¸rt</label></div>
      </div>
      <div class="actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button class="btn ghost" id="btnDel" style="display:none">Slet</button>
        <button class="btn primary" id="btnSave">Gem</button>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settBD" class="backdrop">
    <div class="settings">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Indstillinger Â· Familie</h3>
        <button class="btn ghost" id="settClose">Luk</button>
      </div>
      <div id="settRows"></div>
      <div class="tip">Billeder gemmes lokalt. Farver/avatars synkes via Supabase til alle enheder.</div>
      <div class="actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button class="btn primary" id="settSave">Gem Ã¦ndringer</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- core utils ---------- */
    const HID=(new URLSearchParams(location.search).get("hid")||"DEFAULT").toUpperCase();
    document.getElementById("hidPill").textContent="HID: "+HID;

    const LS_ITEMS="fam_items_v1", LS_PREFS="fam_people_prefs_v1", LS_GIDX="gcal_index";
    const DEFAULT_PEOPLE=[{name:"Alle",color:"#0f172a"},{name:"Far",color:"#ef4444"},{name:"Mor",color:"#8b5cf6"},{name:"Carl",color:"#22c55e"},{name:"Jakob",color:"#0ea5e9"},{name:"Ida",color:"#f59e0b"}];

    const $ = (id)=>document.getElementById(id);
    const grid = $("grid"), peopleBar = $("peopleBar"), weekNo = $("weekNo"), weekBtn = $("weekBtn");
    const gBadge=$("gBadge");

    function fmtISO(d){return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")}
    function fromAnyToLocalISO(x){
      if(!x) return fmtISO(new Date());
      if(/^\d{4}-\d{2}-\d{2}$/.test(x)) return x;                      // "YYYY-MM-DD"
      const t=new Date(x);                                             // handles Z/offsets
      return fmtISO(new Date(t.getFullYear(),t.getMonth(),t.getDate())); // strip time -> local
    }
    function startOfWeek(d=new Date()){const n=(d.getDay()+6)%7;const m=new Date(d);m.setDate(d.getDate()-n);m.setHours(0,0,0,0);return m}
    function weekNumber(d){d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const dn=d.getUTCDay()||7;d.setUTCDate(d.getUTCDate()+4-dn);const ys=new Date(Date.UTC(d.getUTCFullYear(),0,1));return Math.ceil((((d-ys)/86400000)+1)/7)}
    function monthName(m){return["januar","februar","marts","april","maj","juni","juli","august","september","oktober","november","december"][m]}
    function weekLabel(s){const e=new Date(s);e.setDate(s.getDate()+6);return s.getMonth()===e.getMonth()?`${s.getDate()}.â€“${e.getDate()}. ${monthName(e.getMonth())}`:`${s.getDate()}. ${monthName(s.getMonth())} â€“ ${e.getDate()}. ${monthName(e.getMonth())}`}

    function loadLS(k,fallback){try{const v=localStorage.getItem(k);return v?JSON.parse(v):fallback}catch(_){return fallback}}
    function saveLS(k,v){localStorage.setItem(k,JSON.stringify(v))}
    function normalizeType(t){if(t==="Anden aftale"||t==="Andre aftaler")return"Aktivitet";if(t==="Fritidsinteresser")return"Fritidsinteresse";return t||"Aktivitet"}
    function normalizePersonName(name){const raw=(name??"").toString().trim();if(!raw)return"Alle";const pool=(typeof PEOPLE!=="undefined"&&Array.isArray(PEOPLE)&&PEOPLE.length?PEOPLE:DEFAULT_PEOPLE);const lower=raw.toLowerCase();const match=pool.find(p=>(p.name||"").toLowerCase()===lower);return match?match.name:raw}

    function keyOf(it){return[(it.title||"").trim().toLowerCase(),(it.date||"").trim(),(it.time||"").trim(),(it.person||"Alle").trim(),(it.type||"Aktivitet").trim()].join("|")}
    function djb2(s){let h=5381;for(let i=0;i<s.length;i++)h=((h<<5)+h)^s.charCodeAt(i);return (h>>>0).toString(36)}
    function uidFor(it){
      const date = it.date||"";
      if(it.id && it.id.startsWith("gcal:")) return "g:"+it.id.slice(5)+"|"+date;     // id fra GAS, per forekomst
      if(it.id && it.id.startsWith("gcalr:"))return "gr:"+it.id.slice(6);             // hvis du senere bruger ugentlige ankre
      if(it.source==="google") return "g:"+(it.id||djb2(keyOf(it)))+"|"+date;
      return "l:"+djb2(keyOf(it));                                                    // lokale
    }

    /* ---------- state ---------- */
    let PEOPLE, items, current="Alle", editId=null, wk=startOfWeek();
    function loadPrefs(){return loadLS(LS_PREFS,{});}
    function savePrefs(p){saveLS(LS_PREFS,p)}
    function getPeople(){const p=loadPrefs();return DEFAULT_PEOPLE.map(x=>({...x,color:p[x.name]?.color||x.color,avatar:p[x.name]?.avatar||""}))}
    function loadItems(){const arr=loadLS(LS_ITEMS,[]).map(it=>{const person=normalizePersonName(it.person||"Alle");return {...it,type:normalizeType(it.type),person}});saveLS(LS_ITEMS,arr);return arr}
    function saveItems(){saveLS(LS_ITEMS,items)}

    PEOPLE=getPeople(); items=loadItems();

    function personColor(n){const key=(n??"").toString().trim().toLowerCase();if(!key)return"#64748b";const pool=(typeof PEOPLE!=="undefined"&&Array.isArray(PEOPLE)&&PEOPLE.length?PEOPLE:DEFAULT_PEOPLE);const p=pool.find(x=>(x.name||"").toLowerCase()===key);return p?p.color:"#64748b"}
    function personAvatar(n){const key=(n??"").toString().trim().toLowerCase();if(!key)return"";const pool=(typeof PEOPLE!=="undefined"&&Array.isArray(PEOPLE)&&PEOPLE.length?PEOPLE:DEFAULT_PEOPLE);const p=pool.find(x=>(x.name||"").toLowerCase()===key);return p?.avatar||""}

    function buildPeople(){
      peopleBar.innerHTML="";
      for(const p of PEOPLE){
        const b=document.createElement("button");
        b.className="chip"+(p.name===current?" active":"");
        b.style.borderColor=p.name!=="Alle"?personColor(p.name):"";
        const media=p.name!=="Alle"&&personAvatar(p.name)?`<img class="avatar" src="${personAvatar(p.name)}" alt="">`:`<span class="avatar" style="background:${personColor(p.name)}22;display:grid;place-items:center;font-weight:800;color:#111">${p.name[0]}</span>`;
        const label=`<span class="chipName">${p.name}</span>`;
        const tally=p.name!=="Alle"?`<span class="tally" data-person="${p.name}"></span>`:"";
        b.innerHTML=`${media}${label}${tally}`;
        b.onclick=()=>{current=p.name;buildPeople();render()};
        peopleBar.appendChild(b);
      }
    }
    function buildGrid(){
      grid.innerHTML="";
      const names=["mandag","tirsdag","onsdag","torsdag","fredag","lÃ¸rdag","sÃ¸ndag"];
      for(let i=0;i<7;i++){
        const d=new Date(wk);d.setDate(wk.getDate()+i);const iso=fmtISO(d);
        const card=document.createElement("div");card.className="day"+(fmtISO(new Date())===iso?" today":"");card.dataset.date=iso;
        const head=`<div class="head"><div class="name">${names[i]}</div><div class="date">${String(d.getDate()).padStart(2,"0")+". "+String(d.getMonth()+1).padStart(2,"0")+"."}</div></div>`;
        const body=`<div class="list">
          <div class="section" data-section="Aktivitet"><div class="h">Aktiviteter</div><div class="items"></div></div>
          <div class="section" data-section="Fritidsinteresse"><div class="h">Fritidsinteresser</div><div class="items"></div></div>
          <div class="section" data-section="Opgave"><div class="h">Opgaver</div><div class="items"></div></div>
        </div>`;
        card.innerHTML=head+body;grid.appendChild(card);
      }
    }
    function withinWeek(iso){if(!iso)return false;const parts=iso.split("-").map(Number);if(parts.length<3||parts.some(n=>Number.isNaN(n)))return false;const [Y,M,D]=parts;const d=new Date(Y,M-1,D);const e=new Date(wk);e.setDate(wk.getDate()+7);return d>=wk && d<e}

    function materializeRepeats(base){
      const out=[...base];
      const weekISO=fmtISO(wk);
      for(const it of base){
        if(!it||!it.repeatWeekly) continue;
        if(withinWeek(it.date)) continue;
        if(!it.date||!/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(it.date)) continue;
        const [y,m,d]=it.date.split("-").map(Number);
        if([y,m,d].some(n=>Number.isNaN(n))) continue;
        const src=new Date(y,m-1,d);
        if(Number.isNaN(src.getTime())) continue;
        const srcDow=(src.getDay()+6)%7;
        const target=new Date(wk);target.setDate(wk.getDate()+srcDow);
        const clone={...it};
        clone.baseId=it.id;
        clone.id=`rpt|${it.id}|${weekISO}`;
        clone.date=fmtISO(target);
        out.push(clone);
      }
      return out;
    }

    function symbolsForCount(n){
      if(!Number.isFinite(n)||n<=0) return "";
      if(n===1) return "ðŸª™";
      if(n===2) return "ðŸª™ðŸª™";
      if(n===3) return "ðŸŸ¨";
      if(n===4) return "ðŸŸ¨ðŸŸ¨";
      if(n===5) return "ðŸ’Ž";
      if(n===6) return "ðŸ’ŽðŸ’Ž";
      return "ðŸ‘‘";
    }

    function baseId(any){if(!any)return any;if(any.startsWith("rpt|"))return any.split("|")[1];if(any.startsWith("rpt:"))return any.split(":")[1];return any}
    function getByAnyId(id){const b=baseId(id);return items.find(x=>x.id===b)||null}

    function render(){
      weekNo.textContent=weekNumber(wk); weekBtn.textContent=weekLabel(wk); buildGrid();

      const materialized=materializeRepeats(items);
      const normalized=materialized.map(it=>({...it,person:normalizePersonName(it.person)}));

      const visible=normalized
        .filter(it=>withinWeek(it.date))
        .filter(it=>current==="Alle"||it.person===current)
        .sort((a,b)=>a.date.localeCompare(b.date)||(a.time||"").localeCompare(b.time||""));

      const seen=new Set();
      const seenBase=new Set();
      for(const it of visible){
        const UID=uidFor(it); if(seen.has(UID)) continue; seen.add(UID);
        const baseKey=baseId(String(it.id||""));
        if(baseKey&&seenBase.has(baseKey)) continue; if(baseKey) seenBase.add(baseKey);
        const day=document.querySelector(`.day[data-date="${it.date}"]`); if(!day) continue;
        const sec=day.querySelector(`.section[data-section="${normalizeType(it.type)}"] .items`); if(!sec) continue;
        const left = (it.type==="Opgave") ? `<input type="checkbox" ${it.done?'checked':''} data-opg="${it.id}">` : (it.time||'<span class="muted">Heldag</span>');
        const div=document.createElement("div");
        div.className="item"+(it.done?" done":""); div.style.borderLeftColor=personColor(it.person); div.dataset.id=it.id;
        div.innerHTML=`<div class="left">${left}</div><div class="meta"><div class="titlex">${(it.title||"(uden titel)").replace(/[&<>]/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s]))}${it.repeatWeekly?' Â· <span class="muted">â†» uge</span>':''}</div>${it.location?`<div class="note">${it.location}</div>`:""}${it.note?`<div class="note">${it.note}</div>`:""}</div>`;
        div.onclick=(e)=>{if(e.target && e.target.matches('input[type="checkbox"]'))return; openEditor(div.dataset.id)}
        sec.appendChild(div);
      }

      const doneCounts={};
      for(const p of PEOPLE){ if(p.name!=="Alle") doneCounts[p.name]=0; }
      for(const it of normalized){
        if(it.type==="Opgave" && it.done && it.person && withinWeek(it.date)){
          doneCounts[it.person]=(doneCounts[it.person]||0)+1;
        }
      }
      for(const p of PEOPLE){
        if(p.name==="Alle") continue;
        const span=document.querySelector(`.tally[data-person="${p.name}"]`);
        if(span){ span.textContent=symbolsForCount(doneCounts[p.name]||0); }
      }

      document.querySelectorAll('input[data-opg]').forEach(cb=>{
        cb.addEventListener("change",e=>{const any=e.target.getAttribute("data-opg");const it=getByAnyId(any);if(!it)return;it.done=e.target.checked; upsert(it)})
      })
    }

    function upsert(obj){
      obj.type=normalizeType(obj.type); obj.person=normalizePersonName(obj.person||"Alle");
      const UID=uidFor(obj);           // why: stabil identitet
      const i=items.findIndex(x=>uidFor(x)===UID);
      if(i>=0) items[i]={...items[i],...obj}; else items.push(obj);
      saveItems(); render();
    }
    function remove(id){items=items.filter(x=>x.id!==id);saveItems();render()}

    // editor
    const EBD=$("editorBD"), DTitle=$("dlgTitle"), Ftitle=$("f_title"), Ftype=$("f_type"), Fperson=$("f_person"), Fdate=$("f_date"), Ftime=$("f_time"), Fdur=$("f_dur"), Floc=$("f_loc"), Fnote=$("f_note"), Frep=$("f_rep"), Fdone=$("f_done");
    function fillPeopleSelect(){Fperson.innerHTML=PEOPLE.map(p=>`<option${p.name==="Alle"?" selected":""}>${p.name}</option>`).join("")}
    function openNew(dateISO){editId=null;DTitle.textContent="TilfÃ¸j";Ftitle.value="";Ftype.value="Aktivitet";Fperson.value=normalizePersonName("Alle");Fdate.value=dateISO||fmtISO(new Date());Ftime.value="";Fdur.value="";Floc.value="";Fnote.value="";Frep.checked=false;Fdone.checked=false;$("btnDel").style.display="none";EBD.style.display="flex"}
    function openEditor(any){const b=getByAnyId(any);if(!b)return;editId=b.id;DTitle.textContent="Rediger";Ftitle.value=b.title||"";Ftype.value=normalizeType(b.type);Fperson.value=normalizePersonName(b.person||"Alle");Fdate.value=b.date||fmtISO(new Date());Ftime.value=b.time||"";Fdur.value=b.durationMin||"";Floc.value=b.location||"";Fnote.value=b.note||"";Frep.checked=!!b.repeatWeekly;Fdone.checked=!!b.done;$("btnDel").style.display="inline-flex";EBD.style.display="flex"}
    $("dlgClose").onclick=()=>EBD.style.display="none";
    $("btnDel").onclick=()=>{if(editId){remove(editId);EBD.style.display="none"}}
    $("btnSave").onclick=()=>{const existing=editId?getByAnyId(editId):null;const newRepeat=!!Frep.checked;const o={id:editId||("loc:"+Date.now().toString(36)+Math.random().toString(36).slice(2)),title:(Ftitle.value||"(uden titel)").trim(),type:normalizeType(Ftype.value),person:Fperson.value||"Alle",date:Fdate.value,time:Ftime.value||"",durationMin:Fdur.value?parseInt(Fdur.value,10):0,location:(Floc.value||"").trim(),note:(Fnote.value||"").trim(),repeatWeekly:newRepeat,done:!!Fdone.checked,source: editId&&String(editId).startsWith("gcal")?"google":"local"};if(existing&&String(existing.id||"").startsWith("gcal:")){const prevAuto=existing.autoRepeatWeekly;let manualOverride=false;if(prevAuto!==undefined){manualOverride=newRepeat!==prevAuto}else if(existing.repeatWeekly!==newRepeat){manualOverride=true}else{manualOverride=!!existing.manualRepeatWeekly}o.manualRepeatWeekly=manualOverride;if(prevAuto!==undefined)o.autoRepeatWeekly=prevAuto}else if(existing&&existing.manualRepeatWeekly!==undefined){o.manualRepeatWeekly=existing.manualRepeatWeekly;if(existing.autoRepeatWeekly!==undefined)o.autoRepeatWeekly=existing.autoRepeatWeekly}upsert(o);EBD.style.display="none"}

    // header buttons
    $("prev").onclick=()=>{wk.setDate(wk.getDate()-7);render()}
    $("next").onclick=()=>{wk.setDate(wk.getDate()+7);render()}
    weekBtn.onclick=()=>{wk=startOfWeek(new Date());render()}
    $("newBtn").onclick=()=>openNew()
    $("settingsBtn").onclick=()=>{buildSettings();$("settBD").style.display="flex"}
    $("settClose").onclick=()=>{$("settBD").style.display="none"}

    // settings (synk farver/avatars)
    function buildSettings(){const box=$("settRows");box.innerHTML="";for(const p of PEOPLE){const row=document.createElement("div");row.className="row-s";row.innerHTML=`<div class="initial">${(p.name[0]||"?").toUpperCase()}</div><input type="text" value="${p.name}" data-f="name" data-for="${p.name}"><input type="file" accept="image/*" data-f="avatar" data-for="${p.name}"><input type="color" value="${p.color}" data-f="color" data-for="${p.name}"><span class="swatch" style="background:${p.color}"></span>`;row.querySelector('input[type="color"]').addEventListener("input",e=>row.querySelector(".swatch").style.background=e.target.value);box.appendChild(row)}}
    $("settSave").onclick=()=>{const prefs=loadPrefs();document.querySelectorAll("#settRows .row-s").forEach(r=>{const old=r.querySelector('input[data-f="name"]').getAttribute("data-for");const name=r.querySelector('input[data-f="name"]').value.trim()||old;const color=r.querySelector('input[data-f="color"]').value;const fi=r.querySelector('input[data-f="avatar"]');const prev=prefs[old]?.avatar||"";prefs[name]={color,avatar:prev};if(fi.files&&fi.files[0]){const fr=new FileReader();fr.onload=()=>{prefs[name]={color,avatar:fr.result};savePrefs(prefs);if(window._peopleFS?.save)window._peopleFS.save(prefs);refreshPeople()};fr.readAsDataURL(fi.files[0])}});savePrefs(prefs);if(window._peopleFS?.save)window._peopleFS.save(prefs);refreshPeople();$("settBD").style.display="none"}
    function refreshPeople(){PEOPLE=getPeople();fillPeopleSelect();buildPeople();render()}

    /* ---------- Google sync (enkeltforekomster) ---------- */
    const GAS_URL="https://script.google.com/macros/s/AKfycbyQeS_NvMVv4A3IImB6S3AsRt67aSpeKuaoHHSf8K4xRE9sx3zSZS8zHlvZFL_WDIKl/exec";
    function loadGIdx(){return loadLS(LS_GIDX,{})}function saveGIdx(x){saveLS(LS_GIDX,x)}
    function setBadge(t){gBadge.textContent="Google sync: "+t}
    async function fetchEvents(){const u=GAS_URL+(GAS_URL.includes("?")?"&":"?")+"t="+Date.now();const r=await fetch(u,{cache:"no-store"});if(!r.ok)throw new Error("GAS "+r.status);const j=await r.json();return Array.isArray(j.items)?j.items:[]}
    function containsWeekly(val){if(!val)return false;if(typeof val==="string")return/(WEEKLY|\bWEEK\b|\bUGE\b)/i.test(val);if(Array.isArray(val))return val.some(containsWeekly);if(typeof val==="object")return Object.values(val).some(containsWeekly);return false}
    function recurrenceAnchor(ev){if(!ev||typeof ev!=="object")return"";const id=ev.recurringEventId||ev.recurring_event_id||ev.seriesMasterId||ev.series_master_id||ev.masterEventId||ev.master_event_id||ev.parentId||ev.parent_id; if(id) return"rec:"+id; const title=(ev.summary||ev.title||"").trim().toLowerCase(); const time=(ev.time||ev.startTime||ev.start_time||"").toString().trim(); const rawDur=Number(ev.durationMin??ev.durationMinutes??ev.duration??0); const duration=Number.isFinite(rawDur)?rawDur:0; const location=(ev.location||"").trim().toLowerCase(); if(!title&& !time) return""; return"heur:"+[title,time,duration,location].join("|"); }
    function markLikelyWeekly(events){const groups=new Map();for(const ev of events){if(!ev||typeof ev!=="object")continue;const key=recurrenceAnchor(ev);if(!key)continue;const dateISO=fromAnyToLocalISO(ev.startISO||ev.date);if(!dateISO||!/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(dateISO))continue;if(!groups.has(key))groups.set(key,[]);groups.get(key).push({ev,dateISO});}
      const WEEK_MS=7*24*60*60*1000;
      groups.forEach(list=>{if(list.length<2)return;list.sort((a,b)=>a.dateISO.localeCompare(b.dateISO));let weekly=false;for(let i=1;i<list.length;i++){const prev=list[i-1].dateISO,curr=list[i].dateISO;const diff=Math.abs(new Date(curr).getTime()-new Date(prev).getTime());if(diff===0)continue;const ratio=diff/WEEK_MS;const rounded=Math.round(ratio);if(rounded>=1&&Math.abs(ratio-rounded)<=0.15){weekly=true;break;}}
        if(weekly){list.forEach(x=>{x.ev.__weeklyHint=true;});}
      });
    }
    function detectWeeklyRepeat(ev){if(!ev||typeof ev!=="object")return false;if(ev.repeatWeekly||ev.repeat_weekly)return true;if(ev.__weeklyHint)return true;const freq=(ev.repeatFrequency||ev.repeat_frequency||ev.frequency||ev.recurrenceFrequency||"").toString();const type=(ev.repeatType||ev.repeat_type||ev.recurrenceType||"").toString();if(containsWeekly(freq)||containsWeekly(type))return true;const interval=Number(ev.repeatInterval||ev.repeat_interval||ev.interval||ev.recurrenceInterval);if((freq||type)&&Number.isFinite(interval)&&interval===1&&/(week|uge)/i.test(freq+" "+type))return true;return containsWeekly(ev.recurrence)||containsWeekly(ev.recurrenceRule)||containsWeekly(ev.recurrence_rule)||containsWeekly(ev.repeat)||containsWeekly(ev.repeatRule)||containsWeekly(ev.pattern)||containsWeekly(ev.schedule)||containsWeekly(ev.recurrenceText)||containsWeekly(ev.recurrence_text)||containsWeekly(ev.repeatText)||containsWeekly(ev.repeat_text)}
    async function syncNow(){try{setBadge("henterâ€¦");const evs=await fetchEvents();markLikelyWeekly(evs);const idx=loadGIdx();let created=0;for(const ev of evs){const date=fromAnyToLocalISO(ev.startISO||ev.date);const id="gcal:"+ev.id;const repeatWeeklyAuto=detectWeeklyRepeat(ev);const item={id,title:ev.summary||"(uden titel)",type:"Aktivitet",person:"Alle",date,time:ev.time||"",durationMin:ev.durationMin||30,location:ev.location||"",note:ev.description||"",repeatWeekly:repeatWeeklyAuto,done:false,source:"google",manualRepeatWeekly:false,autoRepeatWeekly:repeatWeeklyAuto};const uid=uidFor(item);const existingIdx=items.findIndex(x=>uidFor(x)===uid);const existingItem=existingIdx>=0?items[existingIdx]:null;if(existingItem){item.type=normalizeType(existingItem.type)||item.type;item.person=existingItem.person||item.person;item.done=existingItem.done!==undefined?!!existingItem.done:item.done;if(existingItem.note&&existingItem.note.trim()&&existingItem.note!==item.note)item.note=existingItem.note;const autoPrev=existingItem.autoRepeatWeekly;const manualOverride=!!(existingItem.manualRepeatWeekly||(autoPrev!==undefined&&existingItem.repeatWeekly!==autoPrev));item.manualRepeatWeekly=manualOverride;if(manualOverride){item.repeatWeekly=!!existingItem.repeatWeekly}}item.person=normalizePersonName(item.person);const needsUpdate=!existingItem||["title","type","person","date","time","durationMin","location","note","repeatWeekly","done","manualRepeatWeekly","autoRepeatWeekly"].some(key=>(existingItem?existingItem[key]:undefined)!==item[key]);if(idx[uid]===ev.updated&&!needsUpdate)continue;upsert(item);idx[uid]=ev.updated;created++}saveGIdx(idx);setBadge(created?`+${created} oprettet`:"ingen Ã¦ndringer")}catch(e){console.error(e);setBadge("fejl")}}
    $("gSync").onclick=()=>syncNow()
    $("gReset").onclick=()=>{localStorage.removeItem(LS_GIDX);setBadge("nulstillerâ€¦");syncNow()}

    /* ---------- Supabase bridges ---------- */
  </script>
  <!-- Supabase projektkonfiguration: erstat vÃ¦rdierne nedenfor med dit eget projekt -->
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || "https://nnfkumgdebxdegjykkwp.supabase.co";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uZmt1bWdkZWJ4ZGVnanlra3dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzA5OTYsImV4cCI6MjA3NzcwNjk5Nn0.HjDkwmW-AXvEq3t3UIknu8ut-rWyKFEhbQ9WPIftkLM";
    window.SUPABASE_CONFIG = window.SUPABASE_CONFIG || {
      url: window.SUPABASE_URL,
      anonKey: window.SUPABASE_ANON_KEY
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0/dist/umd/supabase.min.js"></script>
  <script>
    (async function(){
      const cfg=window.SUPABASE_CONFIG||{url:window.SUPABASE_URL||"https://YOUR-PROJECT.supabase.co",anonKey:window.SUPABASE_ANON_KEY||"YOUR_SUPABASE_ANON_KEY"};
      if(!cfg.url||!cfg.anonKey||!window.supabase||typeof window.supabase.createClient!=="function"){
        console.warn("Supabase-konfigurationen mangler eller biblioteket kunne ikke indlÃ¦ses. Autosync er deaktiveret.");
        return;
      }

      const client=window.supabase.createClient(cfg.url,cfg.anonKey,{auth:{persistSession:false}});

      function canon(row,id){
        const base=row&&typeof row==="object"?row:{};
        const payload=base.data&&typeof base.data==="object"?base.data:base;
        const rawUid=typeof base.uid==="string"?base.uid:"";
        let derivedId=payload.id||base.uid||id||"";
        const ensureGoogleIdFromUid=()=>{
          if(!rawUid)return null;
          if(rawUid.startsWith("g:")){
            const body=rawUid.slice(2);
            const [gid,dateHint]=body.split("|");
            return {id:gid?`gcal:${gid}`:"",dateHint:dateHint||"",source:"google"};
          }
          if(rawUid.startsWith("gr:")){
            return {id:`gcalr:${rawUid.slice(3)}`,dateHint:"",source:"google"};
          }
          return null;
        };
        if(!derivedId){
          const guess=ensureGoogleIdFromUid();
          if(guess?.id){
            derivedId=guess.id;
          }
        }
        if(/^g:/.test(derivedId)||/^gr:/.test(derivedId)){
          const guess=ensureGoogleIdFromUid();
          if(guess?.id){
            derivedId=guess.id;
          }
        }
        if(!derivedId){
          derivedId="sb:"+(payload.title||base.title||"item");
        }
        const out={
          id:derivedId,
          title:(payload.title||base.title||"(uden titel)").trim()||"(uden titel)",
          type:normalizeType(payload.type||base.type),
          person:(payload.person||base.person)||"Alle",
          date:fromAnyToLocalISO(payload.date||base.date||""),
          time:(payload.time||base.time)||"",
          durationMin:Number.isFinite(payload.durationMin)?payload.durationMin:(base.duration_min||0),
          location:payload.location||base.location||"",
          note:payload.note||base.note||"",
          repeatWeekly:!!(payload.repeatWeekly||payload.repeat_weekly||base.repeat_weekly),
          done:!!(payload.done??base.done),
          source:payload.source||base.source||"sb",
          manualRepeatWeekly:!!(payload.manualRepeatWeekly??payload.manual_repeat_weekly??base.manual_repeat_weekly??false),
          autoRepeatWeekly:payload.autoRepeatWeekly??payload.auto_repeat_weekly??base.auto_repeat_weekly
        };
        const uidGuess=ensureGoogleIdFromUid();
        if(uidGuess?.dateHint && !out.date){
          out.date=fromAnyToLocalISO(uidGuess.dateHint);
        }
        if(uidGuess?.source && !out.source){
          out.source=uidGuess.source;
        }
        out.person=normalizePersonName(out.person);
        return out;
      }

      let pushLock=false;
      function writeAndRender(arr){
        pushLock=true;
        items=Array.isArray(arr)?arr.map(it=>({...it,person:normalizePersonName(it.person)})) : [];
        saveLS(LS_ITEMS,items);
        pushLock=false;
        try{render()}catch(_){ }
      }

      async function fetchRemoteItems(){
        const {data,error}=await client.from("calendar_items").select("uid,data,title,date,time,person,type,note,done,repeat_weekly").eq("hid",HID);
        if(error){console.error("[Supabase fetch]",error);return new Map();}
        const map=new Map();
        for(const row of data){
          const it=canon(row,row.uid);
          const uid=uidFor(it);
          if(!map.has(uid)) map.set(uid,it);
        }
        return map;
      }

      async function syncFromRemote(){
        const map=await fetchRemoteItems();
        writeAndRender([...map.values()]);
      }

      async function pushAll(localArr){
        try{
          const seen=new Set();
          const rows=[];
          for(const it of localArr){
            if(!it) continue;
            const data={...it,type:normalizeType(it.type),date:fromAnyToLocalISO(it.date)};data.person=normalizePersonName(data.person||"Alle");
            const uid=uidFor(data);
            if(seen.has(uid)) continue;
            seen.add(uid);
            rows.push({
              hid:HID,
              uid,
              data,
              title:data.title,
              date:data.date,
              time:data.time,
              person:data.person,
              type:data.type,
              note:data.note,
              done:!!data.done,
              repeat_weekly:!!data.repeatWeekly
            });
          }

          if(rows.length){
            const {error}=await client.from("calendar_items").upsert(rows,{onConflict:"hid,uid"});
            if(error) throw error;
          }

          const {data:existing,error:existingError}=await client.from("calendar_items").select("uid").eq("hid",HID);
          if(existingError) throw existingError;
          const toDelete=existing.filter(r=>!seen.has(r.uid)).map(r=>r.uid);
          if(toDelete.length){
            const {error:delError}=await client.from("calendar_items").delete().eq("hid",HID).in("uid",toDelete);
            if(delError) throw delError;
          }
        }catch(e){console.error("[Supabase push]",e);}
      }

      function applyPrefs(map){
        const payload=map&&typeof map==="object"?map:{};
        savePrefs(payload);
        refreshPeople();
      }

      async function ensurePrefs(){
        const fallback={};
        for(const p of DEFAULT_PEOPLE) fallback[p.name]={color:p.color,avatar:""};
        try{
          const {data,error,status}=await client.from("people_prefs").select("people").eq("hid",HID).maybeSingle();
          if(error&&status!==406) throw error;
          if(!data){
            applyPrefs(fallback);
            const {error:seedError}=await client.from("people_prefs").upsert({hid:HID,people:fallback});
            if(seedError) throw seedError;
          } else {
            applyPrefs(data.people||fallback);
          }
        }catch(e){console.error("[Supabase prefs fetch]",e);}

        client.channel(`people-prefs-${HID}`)
          .on("postgres_changes",{event:"*",schema:"public",table:"people_prefs",filter:`hid=eq.${HID}`},payload=>{
            applyPrefs(payload.new?.people||{});
          })
          .subscribe();
      }

      await ensurePrefs();

      const local=loadLS(LS_ITEMS,[]);
      const remoteMap=await fetchRemoteItems();
      if(local.length && remoteMap.size===0){
        await pushAll(local);
        await syncFromRemote();
      } else {
        writeAndRender([...remoteMap.values()]);
      }

      client.channel(`calendar-items-${HID}`)
        .on("postgres_changes",{event:"*",schema:"public",table:"calendar_items",filter:`hid=eq.${HID}`},()=>{
          syncFromRemote();
        })
        .subscribe();

      let t=null;
      const origSet=localStorage.setItem.bind(localStorage);
      localStorage.setItem=function(k,v){
        const res=origSet(k,v);
        if(k===LS_ITEMS&&!pushLock){
          clearTimeout(t);
          t=setTimeout(()=>{
            try{
              const arr=JSON.parse(v||"null");
              if(Array.isArray(arr)) pushAll(arr);
            }catch(err){console.error("[Supabase push decode]",err);}
          },300);
        }
        return res;
      };

      window._peopleFS={
        save:async(prefs)=>{
          try{
            const payload=prefs&&typeof prefs==="object"?prefs:{};
            const {error}=await client.from("people_prefs").upsert({hid:HID,people:payload});
            if(error) throw error;
          }catch(e){console.error("[Supabase prefs save]",e);}
        }
      };
    })();
  </script>

  <script>
    // bootstrap UI
    fillPeopleSelect(); buildPeople(); render(); syncNow(); setInterval(syncNow, 120000);
    grid.addEventListener("dblclick",e=>{const day=e.target.closest(".day"); if(day) openNew(day.dataset.date)});
  </script>
</body>
</html>
