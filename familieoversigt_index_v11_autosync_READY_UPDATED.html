<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Familieoversigt</title>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial;background:#f7f7fb;color:#0f172a}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .muted{color:#6b7280}
    .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .bar input, .bar button{padding:10px 12px;border-radius:12px;border:1px solid #e6e8ec;font-size:14px}
    .bar button{background:#0f172a;color:#fff;border-color:#0f172a;cursor:pointer}
    .list{margin-top:16px;background:#fff;border:1px solid #e6e8ec;border-radius:16px}
    .row{display:flex;align-items:center;gap:12px;padding:12px 14px;border-top:1px solid #eef0f4}
    .row:first-child{border-top:0}
    .row input[type="checkbox"]{width:18px;height:18px}
    .grow{flex:1}
    .date{min-width:120px;color:#334155}
    .empty{padding:20px;color:#6b7280;text-align:center}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Familieoversigt <span id="hidPill" class="pill"></span></h1>
    <div class="muted">Realtime synk via Firebase Firestore. (Denne liste er kun en fallback-visning.)</div>

    <div class="bar" id="fallbackBar">
      <input id="titleIn" placeholder="Titel" />
      <input id="dateIn" type="date" />
      <input id="notesIn" placeholder="Noter (valgfri)" />
      <button id="addBtn">Tilføj</button>
    </div>

    <div class="list" id="fallbackList"><div class="empty">Ingen punkter endnu.</div></div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
  /* Firebase init — samme projekt som webkiosk */
  const firebaseConfig = {
    apiKey: "AIzaSyA_gh8y-V6kkI9shRzb0ldBxpKWFY5bAck",
    authDomain: "webkiosk-e5d32.firebaseapp.com",
    projectId: "webkiosk-e5d32",
    storageBucket: "webkiosk-e5d32.firebasestorage.app",
    messagingSenderId: "920175197353",
    appId: "1:920175197353:web:c3520e9a3ab8146ec4fdb8"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  /* HID fra query (?hid=XXXX) */
  const HID = (new URLSearchParams(location.search).get('hid') || 'DEFAULT').toUpperCase();
  document.getElementById('hidPill').textContent = HID;

  /* Path: households/<HID>/calendar/v1/items */
  const itemsCol = db.collection('households').doc(HID).collection('calendar').doc('v1').collection('items');

  /* Ekporteret API så din egen UI kan overtage rendering */
  const itemsListeners = new Set();
  window.CalendarData = {
    hid: HID,
    onItems(cb){ itemsListeners.add(cb); return ()=>itemsListeners.delete(cb); },
    async addItem({title,date,notes=''}) {
      return itemsCol.add({
        title: title||'',
        date:  date||null, /* yyyy-mm-dd eller ISO */
        notes: notes||'',
        done:  false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
    },
    async updateItem(id, patch){
      patch = Object.assign({}, patch, {updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
      return itemsCol.doc(id).set(patch, {merge:true});
    },
    async deleteItem(id){ return itemsCol.doc(id).delete(); },
  };

  /* Auth + realtime feed */
  auth.signInAnonymously().then(()=>{
    itemsCol.orderBy('createdAt','asc').onSnapshot(snap=>{
      const data=[]; snap.forEach(doc=>data.push({id:doc.id, ...doc.data()}));
      // Notify brugers UI
      itemsListeners.forEach(cb=>{ try{ cb(data); }catch(e){} });
      // Fallback UI hvis ingen lytter
      if(itemsListeners.size===0) renderFallback(data);
    });
  }).catch(e=>console.error('[auth]',e));

  /* ======= Fallback UI (kan fjernes hvis du har egen UI) ======= */
  const $=id=>document.getElementById(id);
  function renderFallback(items){
    const box = $('fallbackList'); box.innerHTML='';
    if(!items.length){ box.innerHTML='<div class="empty">Ingen punkter endnu.</div>'; return; }
    for(const it of items){
      const row=document.createElement('div'); row.className='row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.done;
      cb.onchange=()=>window.CalendarData.updateItem(it.id,{done:cb.checked});
      const title=document.createElement('div'); title.className='grow'; title.textContent=it.title||'';
      const date=document.createElement('div'); date.className='date'; date.textContent=it.date||'';
      const del=document.createElement('button'); del.textContent='Slet'; del.style.background='#ef4444'; del.style.borderColor='#ef4444'; del.style.color='#fff'; del.style.cursor='pointer'; del.style.borderRadius='10px'; del.style.padding='8px 10px'; del.onclick=()=>window.CalendarData.deleteItem(it.id);
      row.append(cb,title,date,del);
      box.append(row);
    }
  }
  $('addBtn').onclick=()=>{
    const t=$('titleIn').value.trim(); const d=$('dateIn').value; const n=$('notesIn').value.trim();
    if(!t){ alert('Titel mangler'); return; }
    window.CalendarData.addItem({title:t,date:d,notes:n}).then(()=>{
      $('titleIn').value=''; $('notesIn').value='';
    });
  };
  </script>
</body>
</html>
