<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Webkiosk – Rebuild SAFE</title>
<meta name="theme-color" content="#0f172a" />

<!-- Ingen SW/manifest → ingen cacher, ingen klik-blokering -->
<style>
  :root{
    --bg:#f6f7f9; --panel:#ffffff; --fg:#0f172a; --muted:#6b7280; --border:#e6e8ec;
    --accent:#0f172a; --radius:20px; --shadow:0 10px 30px rgba(2,6,23,.06);
    --logoH:64px; --logoBoxW:42%; --logoMaxW:280px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);display:flex;min-height:100vh}
  .wrap{width:min(1200px,100%);padding:clamp(12px,2vw,24px);margin:auto;position:relative;z-index:1}
  .grid{display:grid;gap:clamp(12px,2vw,18px);grid-template-columns:repeat(12,1fr)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .widget{padding:clamp(16px,2.2vw,24px)}
  .widget h2{margin:0 0 6px;font-size:clamp(15px,1.6vw,18px);color:var(--muted);font-weight:600;letter-spacing:.2px}
  .clock-time{font-size:clamp(40px,6vw,56px);line-height:1;font-weight:750}
  .clock-date{margin-top:6px;font-size:clamp(14px,1.8vw,18px);color:var(--muted)}
  .weather-main{display:flex;align-items:center;gap:14px}
  .weather-temp{font-size:clamp(40px,6vw,56px);font-weight:750}
  .weather-line{font-size:clamp(14px,1.8vw,18px);color:var(--muted)}
  .widget .icon{width:clamp(34px,4.5vw,48px);height:clamp(34px,4.5vw,48px);color:var(--accent)}

  .tiles{grid-column:1/-1;display:grid;gap:clamp(12px,2vw,18px);grid-template-columns:repeat(3,1fr)}
  .tile{min-height:140px;padding:clamp(16px,2.4vw,24px);display:grid;grid-template-columns:1fr minmax(160px,min(var(--logoMaxW),var(--logoBoxW)));align-items:center;gap:clamp(12px,2vw,20px);cursor:pointer;user-select:none;transition:transform .12s ease,box-shadow .12s ease,border-color .12s ease}
  .tile:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(2,6,23,.10)}
  .meta .label{font-size:clamp(18px,2.2vw,22px);font-weight:750;letter-spacing:.2px}
  .meta .sub{color:var(--muted);font-size:clamp(12px,1.8vw,15px);margin-top:6px}
  .logo-box{height:var(--logoH);display:flex;align-items:center;justify-content:flex-end}
  .logo-box img{max-height:100%;max-width:100%;object-fit:contain;display:block}

  .widget.weather{grid-column:span 6}
  .widget.clock{grid-column:span 6}
  @media (max-width:900px){.widget.weather,.widget.clock{grid-column:span 12}.tiles{grid-template-columns:1fr}}

  /* Kalender overlay */
  .calendar-view{position:fixed;inset:0;padding:clamp(12px,2vw,20px);background:rgba(246,247,249,.92);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:60;display:none}
  .calendar-view.visible{display:block}
  .calendar-inner{height:100%;display:flex;flex-direction:column;gap:12px}
  .topbar{display:flex;align-items:center;gap:12px}
  .back-btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:#fff;border:1px solid var(--border);color:var(--fg);cursor:pointer;font-weight:650;box-shadow:var(--shadow)}
  .calframe.panel{flex:1;min-height:0;overflow:hidden;display:flex}
  iframe{width:100%;height:100%;border:0;display:block}

  /* Tandhjul */
  .fab{position:fixed;right:20px;bottom:20px;z-index:90}
  .fab button{width:56px;height:56px;border-radius:50%;border:1px solid var(--border);background:#fff;color:#0f172a;display:inline-flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer}

  /* Modal (indstillinger) */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.28);display:none;align-items:center;justify-content:center;padding:20px;z-index:100}
  .modal.visible{display:flex}
  .dialog{width:min(920px,96vw);max-height:92vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:20px}
  .dialog h3{margin:0 0 10px;font-size:20px}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .form-grid .full{grid-column:1/-1}
  .field{display:flex;flex-direction:column;gap:8px}
  .field label{font-weight:600;font-size:14px;color:#6b7280}
  .hint{font-size:12px;color:#6b7280}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="url"],select,input[type="color"],input[type="search"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px}
  input[type="file"]{font-size:13px}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:650}
  .btn.primary{background:var(--fg);color:#fff;border-color:var(--fg)}
  .logoPreview{width:140px;height:64px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border);border-radius:12px;background:#fafafa}
  .logoPreview img{max-width:100%;max-height:100%;object-fit:contain;display:block}

  /* Webpanel overlay */
  .wk-panel{position:fixed;inset:0;background:#00000010;backdrop-filter:saturate(1.1) blur(4px);display:none;z-index:80}
  .wk-panel.visible{display:block}
  .wk-shell{position:absolute;inset:0;background:#fff;box-shadow:0 12px 60px rgba(2,6,23,.25)}
  .wk-topbar{position:absolute;left:0;right:0;top:0;height:52px;display:flex;align-items:center;gap:10px;padding:0 12px;border-bottom:1px solid var(--border);background:linear-gradient(#fff,#fafafa);z-index:2}
  .wk-topbar .btn{border:1px solid var(--border);border-radius:10px;background:#fff;padding:8px 10px;cursor:pointer}
  .wk-topbar .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .wk-iframe{position:absolute;top:52px;left:0;right:0;bottom:0;width:100%;height:calc(100% - 52px);border:0}
  .wk-blocked{position:absolute;top:52px;left:0;right:0;bottom:0;background:linear-gradient(#fff,#f8f9fb);display:flex;align-items:center;justify-content:center;padding:24px;z-index:2}
  .wk-blocked[hidden]{display:none !important}
  .wk-blocked-card{max-width:420px;width:min(100%,420px);background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:24px;text-align:center;display:flex;flex-direction:column;gap:12px}
  .wk-blocked-card h4{margin:0;font-size:18px;color:var(--fg)}
  .wk-blocked-card p{margin:0;color:var(--muted);font-size:14px;line-height:1.5}
  .wk-blocked-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:6px}

  /* Sync badge */
  .sync-badge{position:fixed;left:12px;bottom:12px;z-index:95;background:#fff;border:1px solid #e6e8ec;border-radius:14px;padding:8px 12px;font:13px/1.2 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;box-shadow:0 8px 24px rgba(2,6,23,.08);display:flex;gap:8px;align-items:center;color:#0f172a}
  .sync-badge .dot{width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,.06);display:inline-block}
  .sync-online .dot{background:#10b981}
  .sync-syncing .dot{background:#f59e0b}
  .sync-offline .dot{background:#9ca3af}
  .sync-error .dot{background:#ef4444}
  .sync-badge .note{margin-left:6px;color:#6b7280;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <section class="panel widget weather" aria-label="Vejr">
        <h2>Vejr</h2>
        <div class="weather-main">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M3 16.5a4.5 4.5 0 0 1 4.5-4.5h.5A6.5 6.5 0 1 1 20 14.5a3.5 3.5 0 0 1-3.5 3.5H8.5A5.5 5.5 0 0 1 3 16.5z"/>
          </svg>
          <div>
            <div class="weather-temp" id="weatherTemp">--°</div>
            <div class="weather-line" id="weatherCond">-</div>
            <div class="weather-line" id="weatherCity">-</div>
          </div>
        </div>
      </section>

      <section class="panel widget clock" aria-label="Ur">
        <h2>Ur</h2>
        <div class="clock-time" id="clockTime">--:--</div>
        <div class="clock-date" id="clockDate">--</div>
      </section>

      <div class="tiles">
        <button class="panel tile" id="tileCalendar" type="button" aria-label="Åbn kalender">
          <div class="meta"><div class="label">Kalender</div><div class="sub">Familieoversigt</div></div>
          <div class="logo-box"><img id="logoCalendar" alt="Kalender-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='64' viewBox='0 0 160 64'%3E%3Crect width='160' height='64' fill='%23f0f2f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%236b7280' font-family='Inter,Arial'%3EKalender%3C/text%3E%3C/svg%3E"></div>
        </button>
        <button class="panel tile" id="tileHomey" type="button" aria-label="Åbn Homey">
          <div class="meta"><div class="label">Homey</div><div class="sub">Dashboard</div></div>
          <div class="logo-box"><img id="logoHomey" alt="Homey-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='64' viewBox='0 0 160 64'%3E%3Crect width='160' height='64' fill='%23f0f2f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%236b7280' font-family='Inter,Arial'%3EHomey%3C/text%3E%3C/svg%3E"></div>
        </button>
        <button class="panel tile" id="tileSonos" type="button" aria-label="Åbn Sonos">
          <div class="meta"><div class="label">Sonos</div><div class="sub">App eller web</div></div>
          <div class="logo-box"><img id="logoSonos" alt="Sonos-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='64' viewBox='0 0 160 64'%3E%3Crect width='160' height='64' fill='%23f0f2f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%236b7280' font-family='Inter,Arial'%3ESonos%3C/text%3E%3C/svg%3E"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Kalender overlay -->
  <section class="calendar-view" id="calendarView" aria-hidden="true">
    <div class="calendar-inner">
      <div class="topbar">
        <button class="back-btn" id="closeCalendar" type="button">⬅ Tilbage</button>
      </div>
      <div class="calframe panel"><iframe id="calendarFrame" title="Kalender"></iframe></div>
    </div>
  </section>

  <!-- Tandhjul -->
  <div class="fab" aria-live="polite">
    <button id="openSettings" title="Indstillinger" aria-label="Indstillinger" type="button">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.26 1.3.73 1.77.47.47 1.11.73 1.77.73h.09a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
      </svg>
    </button>
  </div>

  <!-- Indstillinger modal -->
  <div class="modal" id="settingsModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="dialog">
      <h3 id="settingsTitle">Indstillinger</h3>
      <div class="form-grid">
        <div class="field full">
          <label>Kalenderkilde</label>
          <div class="row">
            <label class="row"><input type="radio" name="calendarMode" value="url" checked> URL</label>
            <label class="row"><input type="radio" name="calendarMode" value="upload"> Upload HTML</label>
          </div>
          <input type="url" id="calendarUrl" placeholder="https://…" />
          <div class="row" id="calendarUploadRow" style="display:none;">
            <input type="file" id="calendarFile" accept="text/html,.html" />
            <span class="hint">Gemmes lokalt i browseren.</span>
          </div>
        </div>

        <div class="field"><label for="homeyUrl">Homey dashboard URL</label><input type="url" id="homeyUrl" placeholder="https://my.homey.app/…"/></div>
        <div class="field"><label for="sonosUrl">Sonos link (app eller web)</label><input type="text" id="sonosUrl" placeholder="sonos:// eller https://"/></div>

        <div class="field"><label>Kalender-logo</label><div class="row"><div class="logoPreview"><img id="prevCalendar" alt=""></div><input type="file" id="logoInputCalendar" accept="image/*"/></div></div>
        <div class="field"><label>Homey-logo</label><div class="row"><div class="logoPreview"><img id="prevHomey" alt=""></div><input type="file" id="logoInputHomey" accept="image/*"/></div></div>
        <div class="field"><label>Sonos-logo</label><div class="row"><div class="logoPreview"><img id="prevSonos" alt=""></div><input type="file" id="logoInputSonos" accept="image/*"/></div></div>

        <div class="field"><label for="themeColor">Primærfarve</label><input type="color" id="themeColor"/></div>
        <div class="field"><label for="bgColor">Baggrundsfarve</label><input type="color" id="bgColor"/></div>

        <div class="field"><label for="householdId">Husstands-ID</label><input id="householdId" placeholder="auto-genereres"/><div class="hint">Brug samme ID på alle enheder.</div></div>
      </div>

      <div class="actions">
        <button class="btn" id="resetConfig" type="button">Nulstil</button>
        <button class="btn" id="closeSettings" type="button">Luk</button>
        <button class="btn primary" id="saveSettings" type="button">Gem</button>
      </div>
    </div>
  </div>

  <!-- Webpanel overlay -->
  <div id="wkPanel" class="wk-panel" aria-hidden="true">
    <div class="wk-shell">
      <div class="wk-topbar">
        <button id="wkBack" class="btn" type="button">← Tilbage</button>
        <div id="wkTitle" class="title">Indlæser…</div>
      </div>
      <iframe id="wkFrame" class="wk-iframe" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox" referrerpolicy="no-referrer"></iframe>
      <div id="wkBlocked" class="wk-blocked" hidden>
        <div class="wk-blocked-card">
          <h4>Kan ikke indlæse siden</h4>
          <p><strong id="wkBlockedHost">play.sonos.com</strong> blokerer for at blive vist i Webkiosk.</p>
          <p>Åbn siden direkte i en ny fane eller brug Sonos-appens link.</p>
          <div class="wk-blocked-actions">
            <button id="wkBlockedClose" class="btn" type="button">Tilbage</button>
            <button id="wkBlockedOpen" class="btn primary" type="button">Åbn fuld Sonos-side</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sync badge -->
  <div id="syncBadge" class="sync-badge sync-offline" aria-live="polite" title="Synk status">
    <span class="dot"></span><span id="syncBadgeText">Offline</span>
    <span id="syncBadgeNote" class="note"></span>
  </div>

  <!-- SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>

  <script>
  // ---- utils
  function $(id){ return document.getElementById(id); }
  function on(el,ev,fn){ if(el && el.addEventListener) el.addEventListener(ev,fn,false); }
  function toB64(file){ return new Promise(function(res,rej){ var fr=new FileReader(); fr.onload=function(){ res(fr.result); }; fr.onerror=rej; fr.readAsDataURL(file); }); }

  // ---- clock
  function updateClock(){
    var t=$('clockTime'), d=$('clockDate'); if(!t||!d) return;
    var now=new Date();
    t.textContent=now.toLocaleTimeString('da-DK',{hour:'2-digit',minute:'2-digit'});
    var dd=now.toLocaleDateString('da-DK',{weekday:'long',day:'2-digit',month:'long'});
    d.textContent=dd.charAt(0).toUpperCase()+dd.slice(1);
  }
  setInterval(updateClock,1000); updateClock();

  // ---- weather
  (function(){
    var elTemp=$('weatherTemp'), elCond=$('weatherCond'), elCity=$('weatherCity'), elIcon=document.querySelector('.widget.weather .icon');
    if(!elTemp||!elCond||!elCity||!elIcon) return;
    function getPosition(timeoutMs){ timeoutMs=timeoutMs||7000; return new Promise(function(resolve){
      var done=false; function fb(){ if(done)return; done=true; resolve({coords:{latitude:55.6761,longitude:12.5683},fallback:true}); }
      if(!navigator.geolocation){ fb(); return; }
      var to=setTimeout(fb,timeoutMs);
      navigator.geolocation.getCurrentPosition(function(p){ if(done)return; done=true; clearTimeout(to); resolve(p); }, function(){ fb(); }, {enableHighAccuracy:false,maximumAge:900000,timeout:timeoutMs-500});
    });}
    async function loadWeather(){ try{
      var pos=await getPosition(); var lat=+pos.coords.latitude.toFixed(4); var lon=+pos.coords.longitude.toFixed(4);
      var r=await fetch("https://api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon+"&current=temperature_2m,weather_code&timezone=auto",{cache:"no-store"}); var j=await r.json();
      var t=Math.round(((j&&j.current)?j.current.temperature_2m:NaN)); if(isFinite(t)) elTemp.textContent=t+"°";
      elCond.textContent=""; elCity.textContent= pos.fallback ? "København" : elCity.textContent;
    }catch(e){} }
    loadWeather(); setInterval(loadWeather,20*60*1000);
  })();

  // ---- config
  var LS_KEY='webkioskConfigV2';
  var defaults={calendar:{mode:'url',url:'',fileName:'',fileData:''},homeyUrl:'',sonosUrl:'',sonosPkg:'',sonosScheme:'',logos:{calendar:'',homey:'',sonos:''},theme:{color:'#0f172a',background:'#f6f7f9'},householdId:'',_ts:0};
  function load(){ try{ var o=JSON.parse(localStorage.getItem(LS_KEY)||'{}'); var r={}; for(var k in defaults){ r[k]=defaults[k]; if(typeof defaults[k]==='object' && defaults[k] && !Array.isArray(defaults[k])){ r[k]=Object.assign({},defaults[k],o[k]||{});} else if(o[k]!==undefined){ r[k]=o[k]; } } return r; }catch(e){ return JSON.parse(JSON.stringify(defaults)); } }
  function save(c){ try{ localStorage.setItem(LS_KEY, JSON.stringify(c)); }catch(e){} }
  var config=load(); if(!config.householdId){ config.householdId=Math.random().toString(36).slice(2,10).toUpperCase(); save(config); }

  function applyTheme(){ document.documentElement.style.setProperty('--accent',config.theme&&config.theme.color?config.theme.color:'#0f172a'); document.documentElement.style.setProperty('--bg',config.theme&&config.theme.background?config.theme.background:'#f6f7f9'); }
  function applyLogos(){ var m=config.logos||{}; if($('logoCalendar') && m.calendar) $('logoCalendar').src=m.calendar; if($('logoHomey') && m.homey) $('logoHomey').src=m.homey; if($('logoSonos') && m.sonos) $('logoSonos').src=m.sonos; if($('prevCalendar') && m.calendar) $('prevCalendar').src=m.calendar; if($('prevHomey') && m.homey) $('prevHomey').src=m.homey; if($('prevSonos') && m.sonos) $('prevSonos').src=m.sonos; }
  function applyForm(){
    if($('calendarUrl')) $('calendarUrl').value=(config.calendar&&config.calendar.url)||'';
    if($('homeyUrl')) $('homeyUrl').value=config.homeyUrl||'';
    if($('sonosUrl')) $('sonosUrl').value=config.sonosUrl||'';
    if($('themeColor')) $('themeColor').value=(config.theme&&config.theme.color)||'#0f172a';
    if($('bgColor')) $('bgColor').value=(config.theme&&config.theme.background)||'#f6f7f9';
    if($('householdId')) $('householdId').value=(config.householdId||'').toUpperCase();
    var radios=[].slice.call(document.querySelectorAll('input[name="calendarMode"]'));
    radios.forEach(function(r){ r.checked=(r.value===((config.calendar&&config.calendar.mode)||'url')); });
    var uploadRow=$('calendarUploadRow'); if(uploadRow) uploadRow.style.display=((config.calendar&&config.calendar.mode)==='upload')?'':'none';
  }
  function applyAllFromConfig(){ applyTheme(); applyForm(); applyLogos(); }
  applyAllFromConfig();

  // ---- modal
  var modal=$('settingsModal');
  function openModal(){ modal.classList.add('visible'); modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.classList.remove('visible'); modal.setAttribute('aria-hidden','true'); }
  on($('openSettings'),'click',openModal);
  on($('closeSettings'),'click',closeModal);
  on(modal,'click',function(e){ if(e.target===modal) closeModal(); });
  [].slice.call(document.querySelectorAll('input[name="calendarMode"]')).forEach(function(r){ on(r,'change',function(){ config.calendar.mode=r.value; var r2=$('calendarUploadRow'); if(r2) r2.style.display=(r.value==='upload')?'':''; queueWriteFirestore(); }); });

  // ---- inputs
  on($('logoInputCalendar'),'change',async function(){ if(!this.files||!this.files[0])return; config.logos.calendar=await toB64(this.files[0]); config._ts=Date.now(); save(config); applyLogos(); queueWriteFirestore(); });
  on($('logoInputHomey'),'change',async function(){ if(!this.files||!this.files[0])return; config.logos.homey=await toB64(this.files[0]); config._ts=Date.now(); save(config); applyLogos(); queueWriteFirestore(); });
  on($('logoInputSonos'),'change',async function(){ if(!this.files||!this.files[0])return; config.logos.sonos=await toB64(this.files[0]); config._ts=Date.now(); save(config); applyLogos(); queueWriteFirestore(); });
  on($('calendarFile'),'change',async function(){ if(!this.files||!this.files[0])return; config.calendar.fileName=this.files[0].name; config.calendar.fileData=await toB64(this.files[0]); config._ts=Date.now(); save(config); queueWriteFirestore(); });

  on($('saveSettings'),'click',function(){
    if($('calendarUrl')) config.calendar.url=$('calendarUrl').value.trim();
    if($('homeyUrl'))    config.homeyUrl=$('homeyUrl').value.trim();
    if($('sonosUrl'))    config.sonosUrl=$('sonosUrl').value.trim();
    if($('themeColor'))  config.theme.color=$('themeColor').value||config.theme.color;
    if($('bgColor'))     config.theme.background=$('bgColor').value||config.theme.background;
    if($('householdId')) config.householdId=$('householdId').value.trim().toUpperCase()||config.householdId;
    config._ts=Date.now(); save(config); applyAllFromConfig(); closeModal(); queueWriteFirestore();
  });
  on($('resetConfig'),'click',function(){ if(confirm('Nulstil alle indstillinger?')){ localStorage.removeItem(LS_KEY); config=load(); if(!config.householdId){config.householdId=Math.random().toString(36).slice(2,10).toUpperCase()} save(config); applyAllFromConfig(); queueWriteFirestore(); } });

  // ---- calendar overlay
  var calView=$('calendarView'), calFrame=$('calendarFrame');
  function openCalendar(){
    var src='';
    if(config.calendar && config.calendar.mode==='upload' && config.calendar.fileData){
      try{ var arr=(config.calendar.fileData||'').split(','); var bytes=atob(arr[1]||''); var buf=new Uint8Array(bytes.length); for(var i=0;i<bytes.length;i++) buf[i]=bytes.charCodeAt(i); src=URL.createObjectURL(new Blob([buf],{type:'text/html'})); }catch(e){ src=config.calendar.fileData; }
    } else { src=(config.calendar&&config.calendar.url)||''; }
    if(!src){ alert('Ingen kalenderkilde valgt.'); return; }
    calFrame.src=src; calView.classList.add('visible'); calView.setAttribute('aria-hidden','false');
  }
  function closeCalendar(){ calView.classList.remove('visible'); calView.setAttribute('aria-hidden','true'); try{ calFrame.src='about:blank'; }catch(e){} }
  on($('tileCalendar'),'click',openCalendar);
  on($('closeCalendar'),'click',closeCalendar);

  // ---- web panel (Homey/Sonos)
  var wkPanel=$('wkPanel'), wkFrame=$('wkFrame'), wkTitle=$('wkTitle'), wkBlocked=$('wkBlocked');
  function showPanel(url,title){
    if(wkTitle) wkTitle.textContent=title||url;
    if(wkBlocked){
      wkBlocked.dataset.url='';
      wkBlocked.setAttribute('hidden','');
      wkBlocked.style.display='none';
    }
    if(wkFrame) wkFrame.src=url;
    if(wkPanel){ wkPanel.classList.add('visible'); wkPanel.setAttribute('aria-hidden','false'); }
  }
  function hidePanel(){
    if(wkPanel){ wkPanel.classList.remove('visible'); wkPanel.setAttribute('aria-hidden','true'); }
    if(wkBlocked){
      wkBlocked.dataset.url='';
      wkBlocked.setAttribute('hidden','');
      wkBlocked.style.display='none';
    }
    try{ if(wkFrame) wkFrame.src='about:blank'; }catch(e){}
  }
  function needsTopLevel(url){
    try{
      var host=new URL(url,location.href).hostname.toLowerCase();
      return host==='sonos.com' || /\.sonos\.com$/.test(host);
    }catch(e){ return false; }
  }
  function showBlocked(url,title){
    if(wkTitle) wkTitle.textContent=title||url;
    if(wkFrame){ try{ wkFrame.src='about:blank'; }catch(e){} }
    if(wkBlocked){
      if(wkBlocked.dataset) wkBlocked.dataset.url=url;
      var hostEl=$('wkBlockedHost');
      if(hostEl){
        try{ hostEl.textContent=new URL(url,location.href).hostname; }
        catch(e){ hostEl.textContent=url; }
      }
      wkBlocked.style.display='';
      wkBlocked.removeAttribute('hidden');
    }
    if(wkPanel){ wkPanel.classList.add('visible'); wkPanel.setAttribute('aria-hidden','false'); }
  }
  on($('wkBack'),'click',hidePanel);
  on($('wkBlockedClose'),'click',hidePanel);
  on($('wkBlockedOpen'),'click',function(){
    var target=(wkBlocked && wkBlocked.dataset && wkBlocked.dataset.url) || '';
    hidePanel();
    if(target){
      var opened=window.open(target,'_blank','noopener');
      if(!opened) location.href=target;
    }
  });

  on($('tileHomey'),'click',function(){
    var url=(config.homeyUrl||'').trim(); if(!url){ alert('Ingen Homey URL sat.'); return; }
    if(/^https?:\/\//i.test(url)) showPanel(url,'Homey'); else location.href=url;
  });

  var isAndroid=/Android/i.test(navigator.userAgent), isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);
  function tryOpenSonosNative(){
    var pkg=(config.sonosPkg||'').trim() || 'com.sonos.acr2';
    var scheme=(config.sonosScheme||config.sonosUrl||'').trim(); // tillad sonos:// i sonosUrl
    if(isiOS && /^sonos:\/\//i.test(scheme)){ location.href=scheme; return true; }
    if(isAndroid && pkg){
      var fb=encodeURIComponent(location.href);
      location.href='intent://open/#Intent;package='+pkg+';S.browser_fallback_url='+fb+';end;';
      setTimeout(function(){ location.href='market://details?id='+pkg; },1200);
      return true;
    }
    return false;
  }
  on($('tileSonos'),'click',function(){
    if(tryOpenSonosNative()) return;
    var link=(config.sonosUrl||'').trim() || 'https://play.sonos.com';
    if(/^https?:\/\//i.test(link)){
      if(needsTopLevel(link)){ showBlocked(link,'Sonos'); return; }
      showPanel(link,'Sonos');
    } else {
      window.open(link,'_self');
    }
  });

  // ---- wake lock (NoSleep)
  var noSleep=null; on(window,'click',function(){ try{ if(!noSleep && window.NoSleep){ noSleep=new NoSleep(); noSleep.enable(); } }catch(e){} });

  // ---- Firebase sync
  var firebaseConfig={apiKey:"AIzaSyA_gh8y-V6kkl95hRzb0ldBxpKWFY5bAck",authDomain:"webkiosk-e5d32.firebaseapp.com",projectId:"webkiosk-e5d32",storageBucket:"webkiosk-e5d32.firebasestorage.app",messagingSenderId:"920175197353",appId:"1:920175197353:web:c3520e9a3ab8146ec4fdb8"};
  var fbApp=firebase.initializeApp(firebaseConfig), fbAuth=firebase.auth(), fbDb=firebase.firestore();

  function badge(state,note){
    var b=$('syncBadge'), t=$('syncBadgeText'), n=$('syncBadgeNote');
    ['sync-online','sync-syncing','sync-offline','sync-error'].forEach(c=>b.classList.remove(c));
    b.classList.add('sync-'+state);
    t.textContent={online:'Online',syncing:'Synkroniserer…',offline:'Offline',error:'Fejl'}[state]||'Offline';
    n.textContent = note?('· '+note):'';
  }
  function nowStr(){ return new Date().toLocaleTimeString('da-DK',{hour:'2-digit',minute:'2-digit'}); }

  fbAuth.signInAnonymously().then(function(){ badge(navigator.onLine?'online':'offline', nowStr()); }).catch(function(){ badge('error','auth'); });
  window.addEventListener('online',  ()=>badge('online', nowStr()));
  window.addEventListener('offline', ()=>badge('offline',''));

  var unsub=null, writeTimer=null;
  function docRef(){ return fbDb.collection('webkiosk').doc((config.householdId||'DEFAULT').toUpperCase()); }
  function queueWriteFirestore(){
    if(writeTimer) clearTimeout(writeTimer);
    writeTimer=setTimeout(async function(){
      try{ config._ts=Date.now(); save(config); await docRef().set(config,{merge:true}); badge('online', nowStr()); }catch(e){ badge('error','write'); }
    },250);
  }
  function startRealtime(){
    try{ if(unsub) unsub(); unsub=docRef().onSnapshot(function(snap){
      if(!snap||!snap.exists) return;
      var remote=snap.data()||{}; var local=load();
      if(remote._ts && (!local._ts || remote._ts>local._ts)){
        config=Object.assign({},local,remote); save(config); applyAllFromConfig();
      }
    }, function(){ badge('error','snapshot'); }); }catch(e){ badge('error','listen'); }
  }
  startRealtime();

  // skriv når vi gemmer eller uploader aktiver
  ['saveSettings','logoInputCalendar','logoInputHomey','logoInputSonos','calendarFile'].forEach(function(id){
    var el=$(id); if(!el) return; el.addEventListener('change', queueWriteFirestore); el.addEventListener('click', queueWriteFirestore);
  });

  // ---- Sikkerhed: sørg for at alle overlays er skjult ved load
  document.addEventListener('DOMContentLoaded', function(){
    ['calendarView','wkPanel','settingsModal','wkBlocked'].forEach(function(id){ var el=$(id); if(el){ el.classList.remove('visible'); el.setAttribute('aria-hidden','true'); el.style.display='none'; } });
  });
  </script>
</body>
</html>
