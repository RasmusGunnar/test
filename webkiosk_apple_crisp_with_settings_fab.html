<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Webkiosk v2025-10-28g</title>
<meta name="theme-color" content="#0f172a" />
<link rel="manifest" href="./manifest.webmanifest" />
<style>
  :root{
    --bg:#f6f7f9; --panel:#ffffff; --fg:#0f172a; --muted:#6b7280;
    --border:#e6e8ec; --accent:#0f172a;
    --radius:20px; --shadow:0 10px 30px rgba(2,6,23,.06);
    --logoH: 64px; --logoBoxW: 42%; --logoMaxW: 280px;
  }
  @media (max-width:1100px){ :root{ --logoBoxW:45%; --logoH:60px } }
  @media (max-width:900px){  :root{ --logoBoxW:50%; --logoH:56px } }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);display:flex;min-height:100vh}
  .wrap{width:min(1200px,100%);padding:clamp(12px,2vw,24px);margin:auto}
  .grid{display:grid;gap:clamp(12px,2vw,18px);grid-template-columns:repeat(12,1fr)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .widget{padding:clamp(16px,2.2vw,24px)}
  .widget h2{margin:0 0 6px;font-size:clamp(15px,1.6vw,18px);color:var(--muted);font-weight:600;letter-spacing:.2px}
  .clock-time{font-size:clamp(40px,6vw,56px);line-height:1;font-weight:750}
  .clock-date{margin-top:6px;font-size:clamp(14px,1.8vw,18px);color:var(--muted)}
  .weather-main{display:flex;align-items:center;gap:14px}
  .weather-temp{font-size:clamp(40px,6vw,56px);font-weight:750}
  .weather-line{font-size:clamp(14px,1.8vw,18px);color:var(--muted)}
  .widget .icon{width:clamp(34px,4.5vw,48px);height:clamp(34px,4.5vw,48px);color:var(--accent)}
  .tiles{grid-column:1/-1;display:grid;gap:clamp(12px,2vw,18px);grid-template-columns:repeat(3,1fr)}
  .tile{min-height:140px;padding:clamp(16px,2.4vw,24px);display:grid;grid-template-columns:1fr minmax(160px,min(var(--logoMaxW),var(--logoBoxW)));align-items:center;gap:clamp(12px,2vw,20px);cursor:pointer;user-select:none;transition:transform .12s ease,box-shadow .12s ease,border-color .12s ease}
  .tile:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(2,6,23,.10)}
  .meta .label{font-size:clamp(18px,2.2vw,22px);font-weight:750;letter-spacing:.2px}
  .meta .sub{color:var(--muted);font-size:clamp(12px,1.8vw,15px);margin-top:6px}
  .logo-box{height:var(--logoH);display:flex;align-items:center;justify-content:flex-end}
  .logo-box img{max-height:100%;max-width:100%;object-fit:contain;display:block}
  .widget.weather{grid-column:span 6}
  .widget.clock{grid-column:span 6}
  @media (max-width:900px){.widget.weather,.widget.clock{grid-column:span 12}.tiles{grid-template-columns:1fr}}
  /* Kalender overlay (som før) */
  .calendar-view{position:fixed;inset:0;padding:clamp(12px,2vw,20px);background:rgba(246,247,249,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:none;z-index:60}
  .calendar-inner{height:100%;display:flex;flex-direction:column;gap:12px}
  .topbar{display:flex;align-items:center;gap:12px}
  .back-btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:#fff;border:1px solid var(--border);color:var(--fg);cursor:pointer;font-weight:650;box-shadow:var(--shadow)}
  .calframe.panel{flex:1;min-height:0;overflow:hidden;display:flex}
  iframe{width:100%;height:100%;border:0;display:block}
  .fab{position:fixed;right:20px;bottom:20px;z-index:70}
  .fab button{width:56px;height:56px;border-radius:50%;border:1px solid var(--border);background:#fff;color:var(--fg);display:inline-flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer}
  .fab button:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(2,6,23,.10)}
  /* Din modal (beholdt) */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.28);display:none;align-items:center;justify-content:center;padding:20px;z-index:80}
  .modal[aria-hidden="false"]{display:flex}
  .dialog{width:min(920px,96vw);max-height:92vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:20px}
  .dialog h3{margin:0 0 10px;font-size:20px}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .form-grid .full{grid-column:1/-1}
  .field{display:flex;flex-direction:column;gap:8px}
  .field label{font-weight:600;font-size:14px;color:var(--muted)}
  .hint{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="url"],select,input[type="color"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px}
  input[type="file"]{font-size:13px}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:650}
  .btn.primary{background:var(--fg);color:#fff;border-color:var(--fg)}
  .logoPreview{width:140px;height:64px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border);border-radius:12px;background:#fafafa}
  .logoPreview img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  /* Webpanel overlay til Homey/Sonos (NYT men matcher dit udtryk) */
  .wk-panel{position:fixed;inset:0;background:#00000010;backdrop-filter:saturate(1.1) blur(4px);display:none;z-index:75}
  .wk-panel.visible{display:block}
  .wk-shell{position:absolute;inset:0;background:#fff;box-shadow:0 12px 60px rgba(2,6,23,.25)}
  .wk-topbar{position:absolute;left:0;right:0;top:0;height:52px;display:flex;align-items:center;gap:10px;padding:0 12px;border-bottom:1px solid var(--border);background:linear-gradient(#fff,#fafafa);z-index:2}
  .wk-topbar .btn{appearance:none;border:1px solid var(--border);border-radius:10px;background:#fff;padding:8px 10px;cursor:pointer}
  .wk-topbar .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .wk-iframe{position:absolute;top:52px;left:0;right:0;bottom:0;width:100%;height:calc(100% - 52px);border:0}
  .wk-fallback{position:absolute;inset:52px 0 0 0;display:none;align-items:center;justify-content:center}
  .wk-fallback .card{max-width:560px;margin:0 14px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,.08);text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <section class="panel widget weather" aria-label="Vejr">
        <h2>Vejr</h2>
        <div class="weather-main">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M3 16.5a4.5 4.5 0 0 1 4.5-4.5h.5A6.5 6.5 0 1 1 20 14.5a3.5 3.5 0 0 1-3.5 3.5H8.5A5.5 5.5 0 0 1 3 16.5z"/>
          </svg>
          <div>
            <div class="weather-temp">18°</div>
            <div class="weather-line">Klart</div>
            <div class="weather-line">Farum</div>
          </div>
        </div>
      </section>

      <section class="panel widget clock" aria-label="Ur">
        <h2>Ur</h2>
        <div class="clock-time" id="clockTime">--:--</div>
        <div class="clock-date" id="clockDate">--</div>
      </section>

      <div class="tiles">
        <button class="panel tile" id="tileCalendar" type="button" aria-label="Åbn kalender" title="Åbn kalender">
          <div class="meta"><div class="label">Kalender</div><div class="sub">Familieoversigt</div></div>
          <div class="logo-box"><img id="logoCalendar" alt="Kalender-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='64' viewBox='0 0 160 64'%3E%3Crect width='160' height='64' fill='%23f0f2f5'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%236b7280' font-family='Inter,Arial'%3EKalender%3C/text%3E%3C/svg%3E"/></div>
        </button>
        <button class="panel tile" id="tileHomey" type="button" aria-label="Åbn Homey" title="Åbn Homey">
          <div class="meta"><div class="label">Homey</div><div class="sub">Dashboard</div></div>
          <div class="logo-box"><img id="logoHomey" alt="Homey-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='64' viewBox='0 0 160 64'%3E%3Crect width='160' height='64' fill='%23f0f2f5'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%236b7280' font-family='Inter,Arial'%3EHomey%3C/text%3E%3C/svg%3E"/></div>
        </button>
        <button class="panel tile" id="tileSonos" type="button" aria-label="Åbn Sonos" title="Åbn Sonos">
          <div class="meta"><div class="label">Sonos</div><div class="sub">App eller web</div></div>
          <div class="logo-box"><img id="logoSonos" alt="Sonos-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='64' viewBox='0 0 160 64'%3E%3Crect width='160' height='64' fill='%23f0f2f5'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%236b7280' font-family='Inter,Arial'%3ESonos%3C/text%3E%3C/svg%3E"/></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Kalender overlay -->
  <section class="calendar-view" id="calendarView" aria-hidden="true">
    <div class="calendar-inner">
      <div class="topbar">
        <button class="back-btn" id="closeCalendar" type="button" aria-label="Luk">⬅ Luk</button>
      </div>
      <div class="calframe panel"><iframe id="calendarFrame" title="Kalender"></iframe></div>
    </div>
  </section>

  <!-- Tandhjul (dit) -->
  <div class="fab" aria-live="polite">
    <button id="openSettings" title="Indstillinger" aria-label="Indstillinger">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.26 1.3.73 1.77.47.47 1.11.73 1.77.73h.09a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
      </svg>
    </button>
  </div>

  <!-- Indstillinger (din modal) + Udseende/Synkronisering/Skærm felter -->
  <div class="modal" id="settingsModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="dialog">
      <h3 id="settingsTitle">Indstillinger</h3>
      <div class="form-grid">
        <div class="field full">
          <label for="calendarMode">Kalenderkilde</label>
          <div class="row">
            <label class="row"><input type="radio" name="calendarMode" value="url" checked> URL</label>
            <label class="row"><input type="radio" name="calendarMode" value="upload"> Upload HTML</label>
          </div>
          <input type="url" id="calendarUrl" placeholder="https://…" />
          <div class="row" id="calendarUploadRow" style="display:none;">
            <input type="file" id="calendarFile" accept="text/html,.html" />
            <span class="hint">Gemmes lokalt i browseren.</span>
          </div>
        </div>

        <div class="field"><label for="homeyUrl">Homey dashboard URL</label><input type="url" id="homeyUrl" placeholder="https://my.homey.app/…"/></div>
        <div class="field"><label for="sonosUrl">Sonos link (app eller web)</label><input type="text" id="sonosUrl" placeholder="sonos:// eller https://"/></div>
        <div class="field"><label for="sonosPkg">Android package (ved Type=App)</label><input type="text" id="sonosPkg" placeholder="fx com.sonos.acr2"/></div>
        <div class="field"><label for="sonosScheme">Custom scheme (iOS/Android – valgfri)</label><input type="text" id="sonosScheme" placeholder="fx sonos://"/></div>

        <div class="field"><label>Kalender-logo</label><div class="row"><div class="logoPreview"><img id="prevCalendar"></div><input type="file" id="logoInputCalendar" accept="image/*"/></div></div>
        <div class="field"><label>Homey-logo</label><div class="row"><div class="logoPreview"><img id="prevHomey"></div><input type="file" id="logoInputHomey" accept="image/*"/></div></div>
        <div class="field"><label>Sonos-logo</label><div class="row"><div class="logoPreview"><img id="prevSonos"></div><input type="file" id="logoInputSonos" accept="image/*"/></div></div>

        <div class="field"><label for="themeColor">Primærfarve</label><input type="color" id="themeColor"/></div>
        <div class="field"><label for="bgColor">Baggrundsfarve</label><input type="color" id="bgColor"/></div>

        <div class="field"><label for="householdId">Husstands-ID</label><input id="householdId" placeholder="auto-genereres"/><div class="hint">Brug samme ID på alle enheder.</div></div>
        <div class="field"><label>Status</label><div class="row"><span id="syncStatus" class="hint">Offline</span></div></div>

        <div class="field"><label for="wakeStrategy">Hold skærmen vågen</label><select id="wakeStrategy"><option value="auto" selected>Auto (Wake Lock → NoSleep)</option><option value="off">Fra</option></select></div>
        <div class="field"><label>Note</label><div class="hint">Installer som PWA for fuldskærm & bedre navigation.</div></div>
      </div>

      <div class="actions">
        <button class="btn" id="resetConfig" type="button">Nulstil</button>
        <button class="btn" id="closeSettings" type="button">Luk</button>
        <button class="btn primary" id="saveSettings" type="button">Gem</button>
      </div>
    </div>
  </div>

  <!-- Webpanel overlay (NYT) -->
  <div id="wkPanel" class="wk-panel" aria-hidden="true">
    <div class="wk-shell">
      <div class="wk-topbar">
        <button id="wkBack" class="btn">← Tilbage</button>
        <div id="wkTitle" class="title">Indlæser…</div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="wkOpenNew" class="btn" title="Åbn i ny fane">↗ Åbn i ny fane</button>
        </div>
      </div>
      <iframe id="wkFrame" class="wk-iframe" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox" referrerpolicy="no-referrer"></iframe>
      <div id="wkFallback" class="wk-fallback">
        <div class="card">
          <h3>Kan ikke vise siden her</h3>
          <p>Siden tillader ikke indlejring. Du kan åbne den i en ny fane i stedet.</p>
          <p><button id="wkOpenNew2" class="btn">↗ Åbn i ny fane</button></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>
  <script>
  /* ===== Version + SW ===== */
  const VERSION = "2025-10-28g";
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register(`./service-worker.js?vv=${encodeURIComponent(VERSION)}`).catch(()=>{});
  }

  /* ===== Ur ===== */
  function updateClock(){
    const now=new Date();
    const t=now.toLocaleTimeString('da-DK',{hour:'2-digit',minute:'2-digit'});
    const d=now.toLocaleDateString('da-DK',{weekday:'long',day:'2-digit',month:'long'});
    document.getElementById('clockTime').textContent=t;
    document.getElementById('clockDate').textContent=d.charAt(0).toUpperCase()+d.slice(1);
  }
  setInterval(updateClock,1000);updateClock();

  /* ===== Local config ===== */
  const LS_KEY='webkioskConfigV2';
  const defaults={
    calendar:{mode:'url',url:'',fileName:'',fileData:''},
    homeyUrl:'',sonosUrl:'',sonosPkg:'',sonosScheme:'',
    logos:{calendar:'',homey:'',sonos:''},
    theme:{color:'#0f172a',background:'#f6f7f9'},
    householdId:'',wakeStrategy:'auto',_ts:0
  };
  function loadConfig(){try{return Object.assign({},defaults,JSON.parse(localStorage.getItem(LS_KEY)||'{}'))}catch{return {...defaults}}}
  function saveConfig(cfg){localStorage.setItem(LS_KEY,JSON.stringify(cfg))}
  let config=loadConfig();

  /* ===== Modal (din) ===== */
  const modal=document.getElementById('settingsModal');
  const btnOpen=document.getElementById('openSettings');
  const btnClose=document.getElementById('closeSettings');
  const btnSave=document.getElementById('saveSettings');
  const btnReset=document.getElementById('resetConfig');
  const calendarUrl=document.getElementById('calendarUrl');
  const calendarFile=document.getElementById('calendarFile');
  const calendarUploadRow=document.getElementById('calendarUploadRow');
  const homeyUrl=document.getElementById('homeyUrl');
  const sonosUrl=document.getElementById('sonosUrl');
  const sonosPkg=document.getElementById('sonosPkg');
  const sonosScheme=document.getElementById('sonosScheme');
  const logoInputs={calendar:document.getElementById('logoInputCalendar'),homey:document.getElementById('logoInputHomey'),sonos:document.getElementById('logoInputSonos')};
  const logoImgs={calendar:document.getElementById('logoCalendar'),homey:document.getElementById('logoHomey'),sonos:document.getElementById('logoSonos')};
  const logoPreviews={calendar:document.getElementById('prevCalendar'),homey:document.getElementById('prevHomey'),sonos:document.getElementById('prevSonos')};
  const modeRadios=[...document.querySelectorAll('input[name="calendarMode"]')];

  function openModal(){modal.setAttribute('aria-hidden','false');applyForm()}
  function closeModal(){modal.setAttribute('aria-hidden','true')}
  btnOpen.addEventListener('click',openModal);btnClose.addEventListener('click',closeModal);
  modal.addEventListener('click',(e)=>{if(e.target===modal)closeModal()});
  function syncCalendarModeUI(){const m=modeRadios.find(r=>r.checked)?.value||'url';calendarUploadRow.style.display=(m==='upload')?'':'none'}
  modeRadios.forEach(r=>r.addEventListener('change',syncCalendarModeUI));

  async function toBase64(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file)})}
  function applyLogos(){['calendar','homey','sonos'].forEach(k=>{const b64=config.logos[k];if(b64){logoImgs[k].src=b64;logoPreviews[k].src=b64}})}
  Object.entries(logoInputs).forEach(([key,input])=>{input.addEventListener('change',async()=>{const f=input.files?.[0];if(!f)return;const b64=await toBase64(f);config.logos[key]=b64;applyLogos();})});
  calendarFile.addEventListener('change',async()=>{const f=calendarFile.files?.[0];if(!f)return;const b64=await toBase64(f);config.calendar.fileName=f.name;config.calendar.fileData=b64});

  function applyTheme(){document.documentElement.style.setProperty('--accent',config.theme.color||'#0f172a');document.documentElement.style.setProperty('--bg',config.theme.background||'#f6f7f9')}
  function applyForm(){
    modeRadios.forEach(r=>r.checked=(r.value===(config.calendar.mode||'url')));syncCalendarModeUI();
    calendarUrl.value=config.calendar.url||'';homeyUrl.value=config.homeyUrl||'';sonosUrl.value=config.sonosUrl||'';sonosPkg.value=config.sonosPkg||'';sonosScheme.value=config.sonosScheme||'';
    const tc=document.getElementById('themeColor'),bg=document.getElementById('bgColor');if(tc)tc.value=config.theme?.color||'#0f172a';if(bg)bg.value=config.theme?.background||'#f6f7f9';
    const hid=document.getElementById('householdId');if(hid){if(!config.householdId){config.householdId=Math.random().toString(36).slice(2,10).toUpperCase();saveConfig(config)}hid.value=config.householdId}
    const ws=document.getElementById('wakeStrategy');if(ws)ws.value=config.wakeStrategy||'auto';
    applyTheme();applyLogos();
  }

  btnSave.addEventListener('click',()=>{
    config.calendar.mode=modeRadios.find(r=>r.checked)?.value||'url';
    config.calendar.url=calendarUrl.value.trim();
    config.homeyUrl=homeyUrl.value.trim();
    config.sonosUrl=sonosUrl.value.trim();
    config.sonosPkg=sonosPkg.value.trim();
    config.sonosScheme=sonosScheme.value.trim();
    const tc=document.getElementById('themeColor'),bg=document.getElementById('bgColor');
    config.theme.color=tc.value||config.theme.color;config.theme.background=bg.value||config.theme.background;
    const hid=document.getElementById('householdId');config.householdId=(hid?.value||config.householdId||'').toUpperCase();
    const ws=document.getElementById('wakeStrategy');config.wakeStrategy=ws?.value||'auto';
    config._ts=Date.now();saveConfig(config);applyTheme();queueWriteFirestore();closeModal();requestWakeLock();
  });
  btnReset.addEventListener('click',()=>{if(confirm('Nulstil alle indstillinger?')){localStorage.removeItem(LS_KEY);config=loadConfig();applyForm()}});

  /* ===== Kalender overlay ===== */
  const calendarView=document.getElementById('calendarView');
  const calendarFrame=document.getElementById('calendarFrame');
  const openCal=document.getElementById('tileCalendar');
  const closeCal=document.getElementById('closeCalendar');
  function openCalendar(){
    let src='';if(config.calendar.mode==='upload'&&config.calendar.fileData){try{const arr=config.calendar.fileData.split(',');const mime=arr[0].match(/data:(.*);base64/)[1]||'text/html';const bytes=atob(arr[1]);const buf=new Uint8Array(bytes.length);for(let i=0;i<bytes.length;i++)buf[i]=bytes.charCodeAt(i);const blob=new Blob([buf],{type:mime});src=URL.createObjectURL(blob)}catch(e){src=config.calendar.fileData}}else if(config.calendar.url){src=config.calendar.url}
    if(!src){alert('Ingen kalenderkilde valgt. Åbn Indstillinger.');return}
    calendarFrame.src=src;calendarView.style.display='block';
  }
  function closeCalendarFn(){calendarView.style.display='none';calendarFrame.src=''}
  openCal.addEventListener('click',openCalendar);closeCal.addEventListener('click',closeCalendarFn);

  /* ===== Webpanel overlay (Homey/Sonos) ===== */
  const wkPanel=document.getElementById('wkPanel');
  const wkFrame=document.getElementById('wkFrame');
  const wkTitle=document.getElementById('wkTitle');
  const wkBack=document.getElementById('wkBack');
  const wkOpenNew=document.getElementById('wkOpenNew');
  const wkOpenNew2=document.getElementById('wkOpenNew2');
  const wkFallback=document.getElementById('wkFallback');
  let currentUrl='';

  function showPanel(){wkPanel.classList.add('visible');wkPanel.setAttribute('aria-hidden','false')}
  function hidePanel(){wkPanel.classList.remove('visible');wkPanel.setAttribute('aria-hidden','true')}
  function safeHost(u){try{return new URL(u).host}catch{return ''}}

  function openWebPanel(url,title=''){
    currentUrl=url;wkTitle.textContent=title||safeHost(url)||'Webvisning';
    wkOpenNew.onclick=()=>window.open(currentUrl,'_blank','noopener,noreferrer');
    wkOpenNew2.onclick=()=>window.open(currentUrl,'_blank','noopener,noreferrer');
    wkFallback.style.display='none';wkFrame.src=url;showPanel();
    wkFrame.addEventListener('load',()=>{wkFallback.style.display='none'},{once:true});
    setTimeout(()=>{try{const loc=wkFrame.contentWindow.location.href;if(!loc||loc==='about:blank'){wkFallback.style.display='flex'}}catch(_){/* cross-origin ok */}},1200);
  }
  function closeWebPanel(){hidePanel();try{wkFrame.src='about:blank'}catch(_){}currentUrl=''}
  wkBack.addEventListener('click',closeWebPanel);

  /* ===== Homey/Sonos knapper → overlay/app ===== */
  document.getElementById('tileHomey').addEventListener('click',()=>{
    const url=(config.homeyUrl||'').trim(); if(!url){alert('Ingen Homey URL sat endnu.');return}
    if(/^https?:\/\//i.test(url)){ openWebPanel(url,'Homey') } else { location.href=url }
  });
  document.getElementById('tileSonos').addEventListener('click',()=>{
    const link=(config.sonosUrl||'').trim();
    const pkg=config.sonosPkg.trim(); const scheme=config.sonosScheme.trim();
    const isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent); const isAndroid=/Android/i.test(navigator.userAgent);
    if(isiOS && scheme){ location.href=scheme; return }
    if(isAndroid && pkg){
      const fallback=encodeURIComponent(location.href);
      const intentUrl=`intent://open/#Intent;package=${pkg};S.browser_fallback_url=${fallback};end;`;
      location.href=intentUrl; setTimeout(()=>{ location.href=`market://details?id=${pkg}` },1200); return;
    }
    if(link){ if(/^https?:\/\//i.test(link)){ openWebPanel(link,'Sonos') } else { location.href=link } }
    else{ alert('Indsæt Sonos link (web) eller angiv package/scheme i Indstillinger.') }
  });

  /* ===== Wake Lock ===== */
  let wakeLock=null,noSleep=null;
  async function requestWakeLock(){
    if((config.wakeStrategy||'auto')==='off'){releaseWakeLock();return}
    try{ if('wakeLock'in navigator){wakeLock=await navigator.wakeLock.request('screen')}
      else{ if(!noSleep) noSleep=new window.NoSleep(); noSleep.enable() } }catch(_){}
  }
  function releaseWakeLock(){ try{if(wakeLock){wakeLock.release();wakeLock=null}}catch(_){}
    try{if(noSleep){noSleep.disable();noSleep=null}}catch(_){}
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') requestWakeLock() },{passive:true});
  window.addEventListener('pageshow',()=>{requestWakeLock()},{passive:true});
  window.addEventListener('click',()=>{ if(!('wakeLock'in navigator)){ try{ if(!noSleep) noSleep=new window.NoSleep(); noSleep.enable() }catch(_){} } },{passive:true});

  /* ===== Firebase (Anon + Firestore) ===== */
  const firebaseConfig={
    apiKey:"AIzaSyA_gh8y-V6kkl95hRzb0ldBxpKWFY5bAck",
    authDomain:"webkiosk-e5d32.firebaseapp.com",
    projectId:"webkiosk-e5d32",
    storageBucket:"webkiosk-e5d32.firebasestorage.app",
    messagingSenderId:"920175197353",
    appId:"1:920175197353:web:c3520e9a3ab8146ec4fdb8"
  };
  const fbApp=firebase.initializeApp(firebaseConfig);
  const fbAuth=firebase.auth();
  const fbDb=firebase.firestore();
  const syncStatusEl=document.getElementById('syncStatus');
  fbAuth.signInAnonymously().then(()=>{ syncStatusEl.textContent='Online' }).catch(()=>{ syncStatusEl.textContent='Auth fejl' });

  let unsub=null,writeTimer=null;
  function docRef(){ return fbDb.collection('webkiosk').doc(config.householdId||'DEFAULT') }
  function queueWriteFirestore(){
    clearTimeout(writeTimer);
    writeTimer=setTimeout(async()=>{ try{
      config._ts=Date.now(); await docRef().set(config,{merge:true}); syncStatusEl.textContent='Synkroniseret'
    }catch(e){ syncStatusEl.textContent='Sync fejl' }},250);
  }
  async function startRealtime(){
    if(!config.householdId){ config.householdId=Math.random().toString(36).slice(2,10).toUpperCase(); saveConfig(config) }
    if(unsub) unsub();
    unsub=docRef().onSnapshot(snap=>{
      if(!snap.exists) return;
      const remote=snap.data(); const local=loadConfig();
      if(remote._ts && (!local._ts || remote._ts>local._ts)){
        config=Object.assign({},local,remote); saveConfig(config); applyForm(); applyTheme();
      }
    });
  }

  /* ===== Bind/boot ===== */
  const logoInputCalendar=document.getElementById('logoInputCalendar');
  const logoInputHomey=document.getElementById('logoInputHomey');
  const logoInputSonos=document.getElementById('logoInputSonos');
  applyTheme(); applyForm(); startRealtime().catch(()=>{});
  // Kalender knap er allerede bundet
  </script>
</body>
</html>
