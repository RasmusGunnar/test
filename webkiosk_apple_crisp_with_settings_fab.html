<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Webkiosk</title>
<meta name="theme-color" content="#0f172a" />
<link rel="manifest" href="./manifest.webmanifest" />
<link rel="icon" href="./assets/icon-192.png" />
<style>
  :root{--bg:#f6f7f9;--panel:#fff;--fg:#0f172a;--muted:#6b7280;--border:#e6e8ec;--accent:#0f172a;--shadow:0 10px 30px rgba(2,6,23,.06);--logoH:64px;--logoBoxW:42%;--logoMaxW:280px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;background:var(--bg);color:var(--fg);display:flex;min-height:100vh}
  .wrap{width:min(1200px,100%);padding:clamp(12px,2vw,24px);margin:auto;position:relative;z-index:1}
  .grid{display:grid;gap:clamp(12px,2vw,18px);grid-template-columns:repeat(12,1fr)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow)}
  .widget{padding:clamp(16px,2.2vw,24px)} .widget h2{margin:0 0 6px;font-size:clamp(15px,1.6vw,18px);color:var(--muted);font-weight:600}
  .clock-time{font-size:clamp(40px,6vw,56px);line-height:1;font-weight:750} .clock-date{margin-top:6px;font-size:clamp(14px,1.8vw,18px);color:var(--muted)}
  .weather-main{display:flex;align-items:center;gap:14px} .weather-temp{font-size:clamp(40px,6vw,56px);font-weight:750} .weather-line{font-size:clamp(14px,1.8vw,18px);color:var(--muted)}
  .widget .icon{width:clamp(34px,4.5vw,48px);height:clamp(34px,4.5vw,48px);color:var(--accent)}
  .tiles{grid-column:1/-1;display:grid;gap:clamp(12px,2vw,18px);grid-template-columns:repeat(3,1fr)}
  .tile{min-height:140px;padding:clamp(16px,2.4vw,24px);display:grid;grid-template-columns:1fr minmax(160px,min(var(--logoMaxW),var(--logoBoxW)));align-items:center;gap:clamp(12px,2vw,20px);cursor:pointer;user-select:none;transition:transform .12s,box-shadow .12s}
  .tile:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(2,6,23,.10)}
  .meta .label{font-size:clamp(18px,2.2vw,22px);font-weight:750} .meta .sub{color:var(--muted);font-size:clamp(12px,1.8vw,15px);margin-top:6px}
  .logo-box{height:var(--logoH);display:flex;align-items:center;justify-content:flex-end}
  .logo-box img{max-height:100%;max-width:100%;object-fit:contain;display:block}
  .widget.weather{grid-column:span 6} .widget.clock{grid-column:span 6}
  @media (max-width:900px){.widget.weather,.widget.clock{grid-column:span 12}.tiles{grid-template-columns:1fr}}

  /* overlays m√• ikke fange klik n√•r skjult */
  [hidden]{display:none !important;}

  /* Kalender-overlay */
  .calendar-view{position:fixed;inset:0;padding:clamp(12px,2vw,20px);background:rgba(246,247,249,.92);backdrop-filter:blur(8px);z-index:60}
  .calendar-inner{height:100%;display:flex;flex-direction:column;gap:12px}
  .topbar{display:flex;align-items:center;gap:12px}
  .back-btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:#fff;border:1px solid var(--border);color:#0f172a;cursor:pointer;font-weight:650;box-shadow:var(--shadow)}
  .calframe.panel{position:relative;flex:1;min-height:0;overflow:hidden;display:flex}
  iframe{width:100%;height:100%;border:0;display:block}

  /* Sonos overlay */
  .sonos-view{position:fixed;inset:0;padding:clamp(12px,2vw,20px);background:rgba(246,247,249,.92);backdrop-filter:blur(8px);z-index:65;display:flex;flex-direction:column}
  .sonos-inner{max-width:1080px;margin:0 auto;display:flex;flex-direction:column;gap:16px;width:100%;height:100%}
  .sonos-body{flex:1;min-height:0;display:grid;grid-template-columns:1fr;gap:16px}
  .sonos-panel{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:clamp(18px,2.2vw,26px);display:flex;flex-direction:column;gap:18px;min-height:0}
  .sonos-header{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  .sonos-groups{display:flex;flex-wrap:wrap;gap:10px}
  .sonos-group{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fbfbfd;color:var(--fg);font-weight:650;cursor:pointer;display:flex;align-items:center;gap:8px;transition:transform .12s,box-shadow .12s}
  .sonos-group.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 12px 30px rgba(15,23,42,.20)}
  .sonos-group:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(2,6,23,.08)}
  .sonos-state{font-size:13px;color:var(--muted)}
  .sonos-now{display:flex;gap:16px;align-items:center}
  .sonos-art{width:90px;height:90px;border-radius:18px;background:linear-gradient(120deg,#f1f4f8,#e2e7ef);display:flex;align-items:center;justify-content:center;overflow:hidden}
  .sonos-art img{width:100%;height:100%;object-fit:cover}
  .sonos-track{display:flex;flex-direction:column;gap:6px;min-width:0}
  .sonos-track-title{font-size:clamp(18px,2.2vw,22px);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sonos-track-meta{color:var(--muted);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sonos-controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .sonos-btn{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--fg);display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-weight:650;transition:transform .12s,box-shadow .12s}
  .sonos-btn:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(2,6,23,.10)}
  .sonos-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .sonos-volume{display:flex;align-items:center;gap:12px;flex:1;min-width:200px}
  .sonos-volume input[type="range"]{flex:1}
  .sonos-members{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .sonos-member{padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:#f8f9fc;display:flex;justify-content:space-between;align-items:center;font-weight:600}
  .sonos-member span{font-size:13px;color:var(--muted);font-weight:500}
  .sonos-favs{display:flex;flex-direction:column;gap:12px}
  .sonos-fav-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
  .sonos-fav{border:1px solid var(--border);border-radius:16px;padding:14px;background:#fff;display:flex;flex-direction:column;gap:8px;cursor:pointer;text-align:left;transition:transform .12s,box-shadow .12s}
  .sonos-fav:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(2,6,23,.10)}
  .sonos-fav-title{font-weight:650;font-size:15px}
  .sonos-fav-desc{font-size:13px;color:var(--muted)}
  .sonos-empty{border:1px dashed var(--border);border-radius:16px;padding:20px;text-align:center;color:var(--muted);font-size:14px}
  .sonos-notice{border:1px solid var(--border);border-radius:16px;padding:18px;background:#fff4;border-left:4px solid #f59e0b;color:#b45309;font-size:14px;line-height:1.5}
  .sonos-notice strong{color:#92400e}
  .sonos-notice-list{margin:12px 0 0 18px;padding:0;display:flex;flex-direction:column;gap:6px}
  .sonos-notice-list li{margin:0;padding:0;list-style:disc;color:#92400e}
  .sonos-notice-list a{color:#1d4ed8;font-weight:600;text-decoration:none}
  .sonos-notice-list a:hover{text-decoration:underline}
  .sonos-footer{display:flex;flex-wrap:wrap;gap:10px}
  .sonos-footer .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--fg);font-weight:650;cursor:pointer}
  .sonos-footer .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .sonos-loader{font-size:14px;color:var(--muted)}
  @media(max-width:700px){.sonos-now{flex-direction:column;align-items:flex-start}.sonos-volume{min-width:0;width:100%}}

  /* FAB */
  .fab{position:fixed;right:20px;bottom:20px;z-index:90}
  .fab button{width:56px;height:56px;border-radius:50%;border:1px solid var(--border);background:#fff;color:#0f172a;display:inline-flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer}

  /* Webpanel (Homey/Sonos) */
  .wk-panel{position:fixed;inset:0;background:#0001;backdrop-filter:saturate(1.1) blur(4px);z-index:80}
  .wk-shell{position:absolute;inset:0;background:#fff;box-shadow:0 12px 60px rgba(2,6,23,.25)}
  .wk-topbar{position:absolute;left:0;right:0;top:0;height:52px;display:flex;align-items:center;gap:10px;padding:0 12px;border-bottom:1px solid var(--border);background:linear-gradient(#fff,#fafafa);z-index:2}
  .wk-topbar .btn{border:1px solid var(--border);border-radius:10px;background:#fff;padding:8px 10px;cursor:pointer}
  .wk-topbar .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .wk-iframe{position:absolute;left:0;right:0;top:52px;bottom:0;width:100%;height:calc(100% - 52px);border:0;display:block;pointer-events:auto;z-index:1}
  .wk-blocked{position:absolute;inset:52px 0 0;background:linear-gradient(#fff,#f8f9fb);display:flex;align-items:center;justify-content:center;padding:24px;z-index:2}
  .wk-blocked[hidden]{display:none !important}
  .wk-blocked-card{max-width:420px;width:min(100%,420px);background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:24px;text-align:center;display:flex;flex-direction:column;gap:12px}
  .wk-blocked-card h4{margin:0;font-size:18px;color:var(--fg)}
  .wk-blocked-card p{margin:0;color:var(--muted);font-size:14px;line-height:1.5}
  .wk-blocked-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:6px}

  /* Modal/indstillinger */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px}
  .dialog{width:min(980px,96vw);max-height:92vh;overflow:hidden;background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:0 22px 60px rgba(2,6,23,.18);display:flex;flex-direction:column;position:relative;z-index:5}
  .dlg-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .dlg-head h3{margin:0;font-size:20px}
  .tabs{display:flex;gap:4px;flex-wrap:wrap;position:relative;z-index:4}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fbfbfb;cursor:pointer;font-weight:600;color:#334155;pointer-events:auto}
  .tab.active{background:#0f172a;color:#fff;border-color:#0f172a}
  .dlg-body{padding:16px 20px 6px;overflow:auto}
  .section{display:none}.section.active{display:block}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .form-grid .full{grid-column:1/-1}
  .field{display:flex;flex-direction:column;gap:8px}
  .field label{font-weight:600;font-size:14px;color:#334155}
  .hint{font-size:12px;color:#6b7280}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="url"],select,input[type="color"],input[type="search"],input[type="checkbox"]{padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px}
  input[type="file"]{font-size:13px}
  .logoPreview{width:160px;height:64px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border);border-radius:12px;background:#fafafa}
  .logoPreview img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .dlg-foot{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:space-between;background:#fafafa;position:sticky;bottom:0}
  .left-note{color:#6b7280;font-size:12px;display:flex;align-items:center;gap:8px}
  .actions{display:flex;gap:10px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:650}
  .btn.primary{background:#0f172a;color:#fff;border-color:#0f172a}
  .sync-badge{position:fixed;left:12px;bottom:12px;z-index:95;background:#fff;border:1px solid #e6e8ec;border-radius:14px;padding:8px 12px;font:13px/1.2 ui-sans-serif;box-shadow:0 8px 24px rgba(2,6,23,.08);display:flex;gap:8px;align-items:center;color:#0f172a}
  .sync-badge .dot{width:10px;height:10px;border-radius:50%}
  .sync-online .dot{background:#10b981}.sync-syncing .dot{background:#f59e0b}.sync-offline .dot{background:#9ca3af}.sync-error .dot{background:#ef4444}
  .sync-badge .note{margin-left:6px;color:#6b7280;font-size:12px}
</style>
</head>
<body>

  <div class="wrap">
    <div class="grid">
      <section class="panel widget weather" aria-label="Vejr">
        <h2>Vejr</h2>
        <div class="weather-main">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 16.5a4.5 4.5 0 0 1 4.5-4.5h.5A6.5 6.5 0 1 1 20 14.5a3.5 3.5 0 0 1-3.5 3.5H8.5A5.5 5.5 0 0 1 3 16.5z"/></svg>
          <div>
            <div class="weather-temp" id="weatherTemp">--¬∞</div>
            <div class="weather-line" id="weatherCond">‚Äî</div>
            <div class="weather-line" id="weatherCity">‚Äî</div>
          </div>
        </div>
      </section>

      <section class="panel widget clock" aria-label="Ur">
        <h2>Ur</h2>
        <div class="clock-time" id="clockTime">--:--</div>
        <div class="clock-date" id="clockDate">--</div>
      </section>

      <div class="tiles">
        <button class="panel tile" id="tileCalendar" type="button" onclick="window.__handlers && window.__handlers.openCalendar()">
          <div class="meta"><div class="label" id="labelCalendar">Kalender</div><div class="sub" id="subCalendar">Familieoversigt</div></div>
          <div class="logo-box"><img id="logoCalendar" alt="Kalender"></div>
        </button>

        <button class="panel tile" id="tileHomey" type="button" onclick="window.__handlers && window.__handlers.openHomey()">
          <div class="meta"><div class="label" id="labelHomey">Homey</div><div class="sub" id="subHomey">Dashboard</div></div>
          <div class="logo-box"><img id="logoHomey" alt="Homey"></div>
        </button>

        <button class="panel tile" id="tileSonos" type="button" onclick="window.__handlers && window.__handlers.openSonos()">
          <div class="meta"><div class="label" id="labelSonos">Sonos</div><div class="sub" id="subSonos">Lokal kontrol</div></div>
          <div class="logo-box"><img id="logoSonos" alt="Sonos"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Kalender overlay -->
  <section class="calendar-view" id="calendarView" aria-hidden="true" hidden>
    <div class="calendar-inner">
      <div class="topbar">
        <button class="back-btn" id="closeCalendar" type="button">‚¨Ö Tilbage</button>
      </div>
      <div class="calframe panel">
        <iframe id="calendarFrame" title="Kalender"></iframe>
      </div>
    </div>
  </section>

  <!-- Sonos overlay -->
  <section class="sonos-view" id="sonosView" aria-hidden="true" hidden>
    <div class="sonos-inner">
      <div class="topbar">
        <button class="back-btn" id="closeSonos" type="button">‚¨Ö Tilbage</button>
        <div id="sonosStatus" class="sonos-loader" role="status">Forbinder til Sonos‚Ä¶</div>
      </div>
      <div class="sonos-body">
        <div class="sonos-panel" id="sonosPanel">
          <div class="sonos-header">
            <div class="sonos-groups" id="sonosGroups" role="tablist" aria-label="Sonos grupper"></div>
            <div class="sonos-state" id="sonosState"></div>
          </div>
          <div class="sonos-now">
            <div class="sonos-art"><img id="sonosArt" alt="Albumcover"/></div>
            <div class="sonos-track">
              <div class="sonos-track-title" id="sonosTrackTitle">Ingen afspilning</div>
              <div class="sonos-track-meta" id="sonosTrackArtist">‚Äî</div>
              <div class="sonos-track-meta" id="sonosTrackAlbum">‚Äî</div>
            </div>
          </div>
          <div class="sonos-controls">
            <div class="sonos-volume">
              <label for="sonosVolume">Lydstyrke</label>
              <input id="sonosVolume" type="range" min="0" max="100" value="0" />
              <span id="sonosVolumeValue">0%</span>
            </div>
            <button class="sonos-btn" id="sonosPrev" type="button">‚èÆ Forrige</button>
            <button class="sonos-btn primary" id="sonosPlayPause" type="button">‚ñ∂ Afspil</button>
            <button class="sonos-btn" id="sonosNext" type="button">‚è≠ N√¶ste</button>
            <button class="sonos-btn" id="sonosMuteToggle" type="button">üîá Sl√• lyd fra</button>
          </div>
          <div class="sonos-members" id="sonosMembers"></div>
          <div class="sonos-favs">
            <h3 style="margin:0;font-size:16px;">Favoritter</h3>
            <div id="sonosFavs" class="sonos-fav-grid"></div>
          </div>
          <div id="sonosNotice" class="sonos-notice" hidden></div>
          <div class="sonos-footer">
            <button class="btn" id="sonosReload" type="button">Opdater</button>
            <button class="btn" id="sonosOpenWeb" type="button">√Öbn Sonos webapp</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FAB: Indstillinger -->
  <div class="fab">
    <button id="openSettings" title="Indstillinger" aria-label="Indstillinger" type="button">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0  0 0-.33-1.82l-.06-.06a2 2 0  1 1 2.83-2.83l.06.06a1.65 1.65 0  0 0 1.82.33H9a1.65 1.65 0  0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0  0 0 1 1.51 1.65 1.65 0  0 0 1.82-.33l.06.06a2 2 0  1 1 2.83 2.83l-.06.06a1.65 1.65 0  0 0-.33 1.82V9c0 .66.26 1.3.73 1.77.47.47 1.11.73 1.77.73h.09a2 2 0  1 1 0 4h-.09a1.65 1.65 0  0 0-1.51 1Z"/></svg>
    </button>
  </div>

  <!-- Indstillinger -->
  <div class="modal" id="settingsModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" hidden>
    <div class="dialog" onclick="event.stopPropagation()">
      <div class="dlg-head">
        <h3 id="settingsTitle">Indstillinger</h3>
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="tab-appearance" type="button">Udseende</button>
          <button class="tab" data-tab="tab-entries" type="button">Indgange</button>
          <button class="tab" data-tab="tab-sync" type="button">Synkronisering</button>
          <button class="tab" data-tab="tab-screen" type="button">Sk√¶rm</button>
        </div>
      </div>

      <div class="dlg-body">
        <section id="tab-appearance" class="section active">
          <div class="form-grid">
            <div class="field"><label for="themeColor">Prim√¶rfarve</label><input type="color" id="themeColor"/></div>
            <div class="field"><label for="bgColor">Baggrundsfarve</label><input type="color" id="bgColor"/></div>
            <div class="field"><label for="logoUrlCalendar">Kalender ‚Äì Logo URL (GitHub)</label><input type="url" id="logoUrlCalendar" placeholder="https://raw.githubusercontent.com/.../calendar.png"/></div>
            <div class="field"><label for="logoUrlHomey">Homey ‚Äì Logo URL (GitHub)</label><input type="url" id="logoUrlHomey" placeholder="https://raw.githubusercontent.com/.../homey.png"/></div>
            <div class="field"><label for="logoUrlSonos">Sonos ‚Äì Logo URL (GitHub)</label><input type="url" id="logoUrlSonos" placeholder="https://raw.githubusercontent.com/.../sonos.png"/></div>
          </div>
          <p class="hint">Tip: L√¶g filer i dit repo (fx <code>/assets/</code>) og brug GitHub ‚ÄúRaw‚Äù URL her.</p>
        </section>

        <section id="tab-entries" class="section">
          <div class="form-grid">
            <div class="field full">
              <label>Kalenderkilde</label>
              <div class="row">
                <label class="row"><input type="radio" name="calendarMode" value="url" checked> URL</label>
                <label class="row"><input type="radio" name="calendarMode" value="upload"> Upload HTML (lokal)</label>
              </div>
              <input type="url" id="calendarUrl" placeholder="https://rasmusgunnar.github.io/kiosk-calendar/"/>
              <div class="row" id="calendarUploadRow" style="display:none;">
                <input type="file" id="calendarFile" accept="text/html,.html"/>
                <span class="hint">Upload gemmes kun lokalt. Deling kr√¶ver URL (GitHub Pages).</span>
              </div>
            </div>

            <div class="field"><label for="homeyUrl">Homey dashboard URL</label><input type="url" id="homeyUrl" placeholder="https://my.homey.app/..."/></div>
            <div class="field"><label for="sonosUrl">Sonos link (app/web/custom scheme)</label><input type="text" id="sonosUrl" placeholder="sonos:// eller https://"/></div>
            <div class="field"><label for="sonosPkg">Android package</label><input type="text" id="sonosPkg" placeholder="com.sonos.acr2"/></div>
            <div class="field"><label for="sonosScheme">Custom scheme</label><input type="text" id="sonosScheme" placeholder="sonos://"/></div>
            <div class="field full">
              <label for="sonosLocalBase">Lokal Sonos-kontrol (LAN)</label>
              <div class="row"><label class="row"><input type="checkbox" id="sonosLocalEnabled"/> Aktiv√©r indbygget Sonos-view</label></div>
              <input type="url" id="sonosLocalBase" placeholder="http://192.168.1.50:8789"/>
              <span class="hint">Standard: <code>http://localhost:8789</code>. Kr√¶ver at denne kiosk kan n√• Sonos-controlleren p√• samme netv√¶rk.</span>
            </div>
          </div>
        </section>

        <section id="tab-sync" class="section">
          <div class="form-grid">
            <div class="field"><label for="householdId">Husstands-ID</label><input id="householdId" placeholder="auto-genereres"/></div>
            <div class="field"><label>Status</label><div class="left-note"><span id="lastSync">‚Äî</span></div></div>
          </div>
        </section>

        <section id="tab-screen" class="section">
          <div class="form-grid">
            <div class="field"><label for="keepAwake">Hold sk√¶rm v√•gen</label><div class="row"><input type="checkbox" id="keepAwake"/><span class="hint">Aktiveres efter f√∏rste tryk.</span></div></div>
          </div>
        </section>
      </div>

      <div class="dlg-foot">
        <div class="left-note"><strong>Synk:</strong> <span id="syncNote">‚Äî</span></div>
        <div class="actions">
          <button class="btn" id="resetConfig" type="button">Nulstil</button>
          <button class="btn" id="closeSettings" type="button">Luk</button>
          <button class="btn primary" id="saveSettings" type="button">Gem</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Webpanel -->
  <div id="wkPanel" class="wk-panel" aria-hidden="true" hidden>
    <div class="wk-shell">
      <div class="wk-topbar">
        <button id="wkBack" class="btn" type="button">‚Üê Tilbage</button>
        <div id="wkTitle" class="title">Indl√¶ser‚Ä¶</div>
      </div>
      <iframe id="wkFrame" class="wk-iframe" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox" referrerpolicy="no-referrer" allow="autoplay; fullscreen; picture-in-picture"></iframe>
      <div id="wkBlocked" class="wk-blocked" hidden>
        <div class="wk-blocked-card">
          <h4>Kan ikke indl√¶se siden</h4>
          <p>Vi kunne ikke indl√¶se <strong id="wkBlockedHost">play.sonos.com</strong> her i panelet.</p>
          <p id="wkBlockedHint">Siden kan v√¶re blokeret for indlejring. √Öbn den evt. direkte i en ny fane.</p>
          <div class="wk-blocked-actions">
            <button id="wkBlockedClose" class="btn" type="button">Tilbage</button>
            <button id="wkBlockedOpen" class="btn primary" type="button">√Öbn fuld Sonos-side</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Synk badge -->
  <div id="syncBadge" class="sync-badge sync-offline" aria-live="polite">
    <span class="dot"></span><span id="syncBadgeText">Offline</span><span id="syncBadgeNote" class="note"></span>
  </div>

  <!-- SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>

  <script>
  const $=id=>document.getElementById(id);
  const on=(el,ev,fn)=>el&&el.addEventListener(ev,fn,false);
  const nowStr=()=>new Date().toLocaleTimeString('da-DK',{hour:'2-digit',minute:'2-digit'});
  const debounced=(ms,fn)=>{let t;return function(){clearTimeout(t);t=setTimeout(()=>fn.apply(this,arguments),ms);};};

  /* Ur */
  function updateClock(){
    const t=$('clockTime'),d=$('clockDate');const n=new Date();
    t.textContent=n.toLocaleTimeString('da-DK',{hour:'2-digit',minute:'2-digit'});
    const s=n.toLocaleDateString('da-DK',{weekday:'long',day:'2-digit',month:'long'});
    d.textContent=s.charAt(0).toUpperCase()+s.slice(1);
  }
  setInterval(updateClock,1000);updateClock();

  /* Vejr (Open-Meteo) */
  (function(){
    const T=$('weatherTemp'), C=$('weatherCity'), D=$('weatherCond'); if(!T||!C||!D) return;
    const WMAP={0:'Klart',1:'Mest klart',2:'Delvist skyet',3:'Overskyet',45:'T√•ge',48:'Isslud/t√•ge',51:'Finregn',53:'Regn',55:'Kraftig regn',56:'Isfinregn',57:'Isregn',61:'Let regn',63:'Regn',65:'Kraftig regn',66:'Isregn',67:'Kraftig isregn',71:'Let sne',73:'Snefald',75:'Kraftig sne',77:'Snebyger',80:'Lette byger',81:'Byger',82:'Kraftige byger',85:'Snebyger',86:'Kraftige snebyger',95:'Tordenvejr',96:'Torden/hagl',99:'Torden/kraftig hagl'};
    function pos(timeout=7000){return new Promise(r=>{let d=false;const fb=()=>{if(d)return;d=true;r({coords:{latitude:55.6761,longitude:12.5683},fallback:true});};if(!navigator.geolocation){fb();return;}const to=setTimeout(fb,timeout);navigator.geolocation.getCurrentPosition(p=>{if(d)return;d=true;clearTimeout(to);r(p);},fb,{maximumAge:900000,timeout:timeout-500});});}
    async function wx(){try{const p=await pos();const la=+p.coords.latitude.toFixed(4),lo=+p.coords.longitude.toFixed(4);const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${la}&longitude=${lo}&current=temperature_2m,weather_code&timezone=auto`);const j=await r.json();const t=Math.round(j?.current?.temperature_2m);const code=j?.current?.weather_code;if(Number.isFinite(t))T.textContent=t+'¬∞';D.textContent=WMAP[code]||'‚Äî';if(p.fallback)C.textContent='K√∏benhavn';}catch{D.textContent='‚Äî';}}
    wx(); setInterval(wx,20*60*1000);
  })();

  /* Config */
  const LS_KEY='webkioskConfigV2';
  const DEFAULT_CAL_PATH='familieoversigt_index_v11_autosync_READY_UPDATED.html';
  const DEFAULT_CAL_URL=(()=>{try{return new URL('./'+DEFAULT_CAL_PATH,location.href).toString();}catch{return DEFAULT_CAL_PATH;}})();
  const defaults={calendar:{mode:'url',url:DEFAULT_CAL_URL,fileName:'',fileData:''},homeyUrl:'',sonosUrl:'',sonosPkg:'',sonosScheme:'',sonosLocal:{enabled:true,baseUrl:SONOS_LOCAL_DEFAULT,lastGroupId:''},logos:{calendar:'',homey:'',sonos:''},logoUrls:{calendar:'',homey:'',sonos:''},theme:{color:'#0f172a',background:'#f6f7f9'},keepAwake:true,householdId:'',_ts:0};
  function load(){try{const o=JSON.parse(localStorage.getItem(LS_KEY)||'{}');const deep=(m,d)=>{const r=Array.isArray(d)?[]:{};for(const k in d){if(d[k]&&typeof d[k]==='object'&&!Array.isArray(d[k]))r[k]=deep((m||{})[k]||{},d[k]);else r[k]=(m||{})[k]!==undefined?(m||{})[k]:d[k];}return r;};return deep(o,defaults);}catch{return JSON.parse(JSON.stringify(defaults));}}
  function save(c){try{localStorage.setItem(LS_KEY,JSON.stringify(c));}catch{}}
  let config=load();

  /* HID l√•s fra ?hid=... (stabil efter cache-rydning) */
  (function lockHIDFromQuery(){
    try{
      const qs=new URLSearchParams(location.search);
      const hidQ=(qs.get('hid')||'').toUpperCase().trim();
      if(hidQ && (!config.householdId || config.householdId.toUpperCase()!==hidQ)){
        config.householdId=hidQ;
        save(config);
      }
    }catch{}
  })();

  if(!config.householdId){config.householdId=Math.random().toString(36).slice(2,10).toUpperCase();save(config);}

  function applyTheme(){document.documentElement.style.setProperty('--accent',config.theme?.color||'#0f172a');document.documentElement.style.setProperty('--bg',config.theme?.background||'#f6f7f9');}
  function applyForm(){ $('themeColor').value=config.theme?.color||'#0f172a'; $('bgColor').value=config.theme?.background||'#f6f7f9'; $('keepAwake').checked=!!config.keepAwake; $('logoUrlCalendar').value=config.logoUrls?.calendar||''; $('logoUrlHomey').value=config.logoUrls?.homey||''; $('logoUrlSonos').value=config.logoUrls?.sonos||''; $('calendarUrl').value=config.calendar?.url||DEFAULT_CAL_URL; $('homeyUrl').value=config.homeyUrl||''; $('sonosUrl').value=config.sonosUrl||''; $('sonosPkg').value=config.sonosPkg||''; $('sonosScheme').value=config.sonosScheme||''; $('sonosLocalBase').value=(config.sonosLocal?.baseUrl||SONOS_LOCAL_DEFAULT); $('sonosLocalEnabled').checked=!!config.sonosLocal?.enabled; $('householdId').value=(config.householdId||'').toUpperCase(); const mode=config.calendar?.mode||'url'; [...document.querySelectorAll('input[name="calendarMode"]')].forEach(r=>r.checked=(r.value===mode)); $('calendarUploadRow').style.display=(mode==='upload')?'':'none'; }
  function applyLogos(){ const ph=t=>"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='64'%3E%3Crect width='160' height='64' fill='%23f0f2f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%236b7280' font-family='Inter,Arial' %3E"+encodeURIComponent(t)+"%3C/text%3E%3C/svg%3E"; $('logoCalendar').src=config.logoUrls.calendar||config.logos.calendar||ph('Kalender'); $('logoHomey').src=config.logoUrls.homey||config.logos.homey||ph('Homey'); $('logoSonos').src=config.logoUrls.sonos||config.logos.sonos||ph('Sonos'); }
  function applySonosSubtitle(){ const el=$('subSonos'); if(!el) return; if(config.sonosLocal?.enabled){el.textContent='Lokal kontrol';} else if((config.sonosUrl||'').trim()){el.textContent='Ekstern Sonos-link';} else {el.textContent='App eller web';}}
  function applyAll(){applyTheme();applyForm();applyLogos();applySonosSubtitle();} applyAll();

  /* Tabs */
  function setupTabs(){
    const dlg=document.querySelector('#settingsModal .dialog'); if(!dlg) return;
    const tabs=[...dlg.querySelectorAll('.tab')];
    const sections=[...dlg.querySelectorAll('.section')];
    const act=(id)=>{ tabs.forEach(t=>t.classList.toggle('active',t.dataset.tab===id));
                      sections.forEach(s=>s.classList.toggle('active',s.id===id)); };
    tabs.forEach(btn=>{ btn.onclick=(e)=>{e.preventDefault();e.stopPropagation();act(btn.dataset.tab);} });
    const first=tabs.find(t=>t.classList.contains('active'))||tabs[0]; if(first) act(first.dataset.tab);
  }

  /* Bind UI */
  const writeSoon=debounced(300,queueWriteFirestore);
  function bind(){
    on($('themeColor'),'input',function(){config.theme.color=this.value;save(config);applyTheme();writeSoon();});
    on($('bgColor'),'input',function(){config.theme.background=this.value;save(config);applyTheme();writeSoon();});
    on($('keepAwake'),'change',function(){config.keepAwake=!!this.checked;save(config);writeSoon();});

    on($('logoUrlCalendar'),'input',function(){config.logoUrls.calendar=this.value.trim();save(config);applyLogos();writeSoon();});
    on($('logoUrlHomey'),'input',function(){config.logoUrls.homey=this.value.trim();save(config);applyLogos();writeSoon();});
    on($('logoUrlSonos'),'input',function(){config.logoUrls.sonos=this.value.trim();save(config);applyLogos();writeSoon();});

    ;[...document.querySelectorAll('input[name="calendarMode"]')].forEach(r=>on(r,'change',function(){config.calendar.mode=r.value;save(config);applyForm();writeSoon();}));
    on($('calendarUrl'),'input',function(){config.calendar.url=this.value.trim()||DEFAULT_CAL_URL;save(config);writeSoon();});
    on($('calendarFile'),'change',async function(){if(this.files&&this.files[0]){const f=this.files[0];const txt=await f.text();config.calendar.fileName=f.name;config.calendar.fileData="data:text/html;base64,"+btoa(unescape(encodeURIComponent(txt)));config.calendar.mode='upload';save(config);writeSoon();alert('Kalender gemt lokalt. For deling: brug URL (GitHub Pages).');}});

    on($('homeyUrl'),'input',function(){config.homeyUrl=this.value.trim();save(config);writeSoon();});
    on($('sonosUrl'),'input',function(){config.sonosUrl=this.value.trim();save(config);applySonosSubtitle();writeSoon();});
    on($('sonosPkg'),'input',function(){config.sonosPkg=this.value.trim();save(config);writeSoon();});
    on($('sonosScheme'),'input',function(){config.sonosScheme=this.value.trim();save(config);writeSoon();});
    on($('sonosLocalBase'),'input',function(){config.sonosLocal=config.sonosLocal||{};config.sonosLocal.baseUrl=this.value.trim()||SONOS_LOCAL_DEFAULT;save(config);writeSoon();});
    on($('sonosLocalEnabled'),'change',function(){config.sonosLocal=config.sonosLocal||{};config.sonosLocal.enabled=!!this.checked;save(config);applySonosSubtitle();writeSoon();});

    on($('householdId'),'input',function(){const v=this.value.trim().toUpperCase();if(v){config.householdId=v;save(config);startRealtime();writeSoon();}});

    on($('saveSettings'),'click',()=>{config._ts=Date.now();save(config);queueWriteFirestore();hideSettings();});
    on($('resetConfig'),'click',()=>{if(confirm('Nulstil alle indstillinger?')){localStorage.removeItem(LS_KEY);config=load();if(!config.householdId){config.householdId=Math.random().toString(36).slice(2,10).toUpperCase()}save(config);applyAll();startRealtime();queueWriteFirestore();}});
    on($('closeSettings'),'click',hideSettings);
    on($('openSettings'),'click',showSettings);
  }
  bind();

  /* Overlays */
  function showSettings(){const m=$('settingsModal');m.removeAttribute('hidden');m.setAttribute('aria-hidden','false');setupTabs();}
  function hideSettings(){const m=$('settingsModal');m.setAttribute('hidden','');m.setAttribute('aria-hidden','true');}

  /* Kalender ‚Äì self-iframe guard */
  function openCalendar(){
    const hid=(config.householdId||'DEFAULT').toUpperCase();
    // Luk evt. tidligere overlay for at undg√• stacking
    const v0=$('calendarView'), f0=$('calendarFrame');
    if(v0 && !v0.hasAttribute('hidden')){ try{f0.src='about:blank';}catch{} v0.setAttribute('hidden',''); v0.setAttribute('aria-hidden','true'); }

    let base='';
    if(config.calendar?.mode==='upload' && config.calendar?.fileData){ base=config.calendar.fileData; }
    else { base=(config.calendar?.url||DEFAULT_CAL_URL).trim()||DEFAULT_CAL_URL; }

    try{
      const here=new URL(location.href);
      const target=new URL(base,location.href);
      const samePath=here.pathname.replace(/\/+$/,'')===target.pathname.replace(/\/+$/,'');
      const looksLikeSelf=/webkiosk_apple_crisp_with_settings_fab\.html/i.test(target.pathname)||/\/test\/?$/i.test(target.pathname);
      if((here.origin===target.origin && samePath) || looksLikeSelf){
        alert('Kalender-URL peger p√• Webkiosk-siden. S√¶t URL til: '+DEFAULT_CAL_URL);
        return;
      }
    }catch{}

    let src=base;
    if(!/^data:/i.test(base)){
      try{ const u=new URL(base,location.href); u.searchParams.set('hid',hid); src=u.toString(); }
      catch{ src=base+(base.includes('?')?'&':'?')+'hid='+encodeURIComponent(hid); }
    }

    const frame=$('calendarFrame'), view=$('calendarView');
    if(!frame||!view){ alert('Kalender-visning mangler i HTML.'); return; }
    frame.src=src; view.removeAttribute('hidden'); view.setAttribute('aria-hidden','false');
  }
  window.__handlers={openCalendar};
  on($('closeCalendar'),'click',()=>{ $('calendarFrame').src='about:blank'; const v=$('calendarView'); v.setAttribute('hidden',''); v.setAttribute('aria-hidden','true'); });

  /* Sonos lokal kontrol (LAN) */
  const SONOS_LOCAL_DEFAULT=(()=>{
    const host=(location.hostname||'localhost').trim()||'localhost';
    return `http://${host}:8789`;
  })();
  const SONOS_ART_PLACEHOLDER="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect width='120' height='120' rx='18' fill='%23e5e7eb'/%3E%3Cpath d='M32 58h56v4H32z' fill='%236b7280'/%3E%3C/svg%3E";
  const sonosLocal={pollTimer:null,abortController:null,currentGroupId:'',state:null};
  const sonosDom={
    view:$('sonosView'),
    status:$('sonosStatus'),
    groups:$('sonosGroups'),
    state:$('sonosState'),
    art:$('sonosArt'),
    trackTitle:$('sonosTrackTitle'),
    trackArtist:$('sonosTrackArtist'),
    trackAlbum:$('sonosTrackAlbum'),
    volume:$('sonosVolume'),
    volumeValue:$('sonosVolumeValue'),
    prev:$('sonosPrev'),
    playPause:$('sonosPlayPause'),
    next:$('sonosNext'),
    muteToggle:$('sonosMuteToggle'),
    members:$('sonosMembers'),
    favs:$('sonosFavs'),
    notice:$('sonosNotice'),
    reload:$('sonosReload'),
    openWeb:$('sonosOpenWeb')
  };

  function sonosLocalBase(){
    const base=(config.sonosLocal?.baseUrl||'').trim();
    return base||SONOS_LOCAL_DEFAULT;
  }
  function sonosLocalUrl(path){
    const base=sonosLocalBase();
    if(!base) return '';
    return base.replace(/\/+$/,'')+path;
  }
  function cancelSonosPoll(){ if(sonosLocal.pollTimer){ clearTimeout(sonosLocal.pollTimer); sonosLocal.pollTimer=null; } }
  function scheduleSonosPoll(){ cancelSonosPoll(); sonosLocal.pollTimer=setTimeout(()=>sonosLocalRefresh(false),6000); }
  function setSonosStatus(text){ if(sonosDom.status){ sonosDom.status.textContent=text; } }
  function hideSonosNotice(){ if(sonosDom.notice){ sonosDom.notice.setAttribute('hidden',''); sonosDom.notice.innerHTML=''; } }
  function showSonosNotice(base,message){
    if(!sonosDom.notice) return;
    const effectiveBase=base||sonosLocalBase();
    sonosDom.notice.innerHTML='';
    const strong=document.createElement('strong');
    strong.textContent='Kan ikke forbinde til Sonos-controlleren.';
    sonosDom.notice.appendChild(strong);
    const p=document.createElement('div');
    p.textContent='Er du p√• samme netv√¶rk som Sonos? Vi kunne ikke n√•: ';
    const code=document.createElement('code');
    code.textContent=effectiveBase;
    p.appendChild(code);
    sonosDom.notice.appendChild(p);
    const extra=document.createElement('div');
    extra.textContent=message||'Hvis du tilg√•r l√∏sningen uden for hjemmenetv√¶rket, virker den lokale kontrol ikke.';
    sonosDom.notice.appendChild(extra);
    const list=document.createElement('ul');
    list.className='sonos-notice-list';
    const first=document.createElement('li');
    first.textContent='Start den lokale controller via "npm start" eller brug hj√¶lpescriptet i assets-mappen.';
    list.appendChild(first);
    if(location.protocol==='https:' && /^http:/i.test(effectiveBase||'')){
      const mixed=document.createElement('li');
      mixed.textContent='Browseren blokerer usikkert indhold. √Öbn Webkiosken via HTTP eller start controlleren med HTTPS-certifikat (se guide).';
      list.appendChild(mixed);
    }
    const docItem=document.createElement('li');
    const docLink=document.createElement('a');
    docLink.href='assets/sonos-local-setup.md';
    docLink.target='_blank';
    docLink.rel='noopener';
    docLink.textContent='Se ops√¶tningsguide';
    docItem.appendChild(docLink);
    list.appendChild(docItem);
    sonosDom.notice.appendChild(list);
    sonosDom.notice.removeAttribute('hidden');
  }
  function resetSonosUi(){
    if(sonosDom.art) sonosDom.art.src=SONOS_ART_PLACEHOLDER;
    if(sonosDom.trackTitle) sonosDom.trackTitle.textContent='Ingen afspilning';
    if(sonosDom.trackArtist) sonosDom.trackArtist.textContent='‚Äî';
    if(sonosDom.trackAlbum) sonosDom.trackAlbum.textContent='‚Äî';
    if(sonosDom.volume){ sonosDom.volume.value=0; }
    if(sonosDom.volumeValue) sonosDom.volumeValue.textContent='0%';
    if(sonosDom.groups){
      sonosDom.groups.innerHTML='';
      const empty=document.createElement('div');
      empty.className='sonos-empty';
      empty.textContent='Ingen Sonos-grupper fundet.';
      sonosDom.groups.appendChild(empty);
    }
    if(sonosDom.members){ sonosDom.members.innerHTML=''; }
    if(sonosDom.favs){ sonosDom.favs.innerHTML=''; }
    if(sonosDom.state) sonosDom.state.textContent='‚Äî';
    if(sonosDom.playPause){ sonosDom.playPause.textContent='‚ñ∂ Afspil'; sonosDom.playPause.disabled=true; }
    if(sonosDom.prev) sonosDom.prev.disabled=true;
    if(sonosDom.next) sonosDom.next.disabled=true;
    if(sonosDom.muteToggle){ sonosDom.muteToggle.textContent='üîá Sl√• lyd fra'; sonosDom.muteToggle.disabled=true; }
  }
  function selectSonosGroup(id){
    sonosLocal.currentGroupId=id;
    config.sonosLocal=config.sonosLocal||{};
    config.sonosLocal.lastGroupId=id;
    save(config);
    renderSonosState();
  }
  function renderSonosState(){
    const state=sonosLocal.state||{};
    const groups=Array.isArray(state.groups)?state.groups:[];
    const current=groups.find(g=>g.id===sonosLocal.currentGroupId) || groups[0] || null;
    if(current && current.id!==sonosLocal.currentGroupId){
      sonosLocal.currentGroupId=current.id;
      config.sonosLocal=config.sonosLocal||{};
      config.sonosLocal.lastGroupId=current.id;
      save(config);
    }
    if(sonosDom.groups){
      sonosDom.groups.innerHTML='';
      if(groups.length){
        groups.forEach(group=>{
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='sonos-group'+(group.id===sonosLocal.currentGroupId?' active':'');
          btn.textContent=group.name||'Ukendt gruppe';
          btn.addEventListener('click',()=>selectSonosGroup(group.id));
          sonosDom.groups.appendChild(btn);
        });
      }else{
        const empty=document.createElement('div');
        empty.className='sonos-empty';
        empty.textContent='Ingen Sonos-grupper fundet.';
        sonosDom.groups.appendChild(empty);
      }
    }
    if(sonosDom.state){
      if(current){
        const playing=current.isPlaying?'Afspiller':'Pause';
        const volume=Number.isFinite(current.volume)?(current.volume+'%'):'‚Äî';
        sonosDom.state.textContent=playing+' ¬∑ Vol '+volume;
      }else if(groups.length){
        sonosDom.state.textContent='V√¶lg en gruppe';
      }else{
        sonosDom.state.textContent='Ingen grupper tilg√¶ngelige';
      }
    }
    if(sonosDom.art){
      let art=current?.track?.artUri||'';
      if(art && /^\//.test(art)){ art=sonosLocalBase().replace(/\/+$/,'')+art; }
      sonosDom.art.src=art||SONOS_ART_PLACEHOLDER;
    }
    if(sonosDom.trackTitle) sonosDom.trackTitle.textContent=current?.track?.title||'Ingen afspilning';
    if(sonosDom.trackArtist){
      const parts=[];
      if(current?.track?.artist) parts.push(current.track.artist);
      if(current?.track?.station && !parts.includes(current.track.station)) parts.push(current.track.station);
      sonosDom.trackArtist.textContent=parts.length?parts.join(' ¬∑ '):'‚Äî';
    }
    if(sonosDom.trackAlbum) sonosDom.trackAlbum.textContent=current?.track?.album||'‚Äî';
    const volumeValue=Number.isFinite(current?.volume)?current.volume:0;
    if(sonosDom.volume){ sonosDom.volume.value=volumeValue; }
    if(sonosDom.volumeValue) sonosDom.volumeValue.textContent=volumeValue+'%';
    if(sonosDom.playPause){
      sonosDom.playPause.disabled=!current;
      sonosDom.playPause.textContent=current&&current.isPlaying?'‚è∏ Pause':'‚ñ∂ Afspil';
    }
    if(sonosDom.prev) sonosDom.prev.disabled=!current;
    if(sonosDom.next) sonosDom.next.disabled=!current;
    if(sonosDom.muteToggle){
      sonosDom.muteToggle.disabled=!current;
      sonosDom.muteToggle.textContent=current&&current.muted?'üîä Sl√• lyd til':'üîá Sl√• lyd fra';
    }
    if(sonosDom.members){
      sonosDom.members.innerHTML='';
      if(current?.members?.length){
        current.members.forEach(member=>{
          const row=document.createElement('div');
          row.className='sonos-member';
          const name=document.createElement('span');
          name.textContent=member.name||'Ukendt enhed';
          const info=document.createElement('span');
          const vol=Number.isFinite(member.volume)?member.volume+'%':'‚Äî';
          info.textContent=member.muted?vol+' ¬∑ Muted':vol;
          row.appendChild(name);
          row.appendChild(info);
          sonosDom.members.appendChild(row);
        });
      }else{
        const empty=document.createElement('div');
        empty.className='sonos-empty';
        empty.textContent='Ingen medlemmer i gruppen.';
        sonosDom.members.appendChild(empty);
      }
    }
    if(sonosDom.favs){
      sonosDom.favs.innerHTML='';
      const favorites=Array.isArray(state.favorites)?state.favorites:[];
      if(favorites.length){
        favorites.forEach(fav=>{
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='sonos-fav';
          const title=document.createElement('div');
          title.className='sonos-fav-title';
          title.textContent=fav.title||'Ukendt';
          const desc=document.createElement('div');
          desc.className='sonos-fav-desc';
          desc.textContent=fav.description||'';
          btn.appendChild(title);
          btn.appendChild(desc);
          btn.addEventListener('click',()=>sendSonosCommand('playFavorite',{favoriteId:fav.id}));
          sonosDom.favs.appendChild(btn);
        });
      }else{
        const empty=document.createElement('div');
        empty.className='sonos-empty';
        empty.textContent='Ingen favoritter fundet.';
        sonosDom.favs.appendChild(empty);
      }
    }
  }
  async function sonosLocalRefresh(force){
    if(!config.sonosLocal?.enabled || !sonosDom.view || sonosDom.view.hasAttribute('hidden')) return;
    const url=sonosLocalUrl('/api/state');
    if(!url){ showSonosNotice('', 'Angiv en gyldig base-URL i indstillingerne.'); return; }
    if(sonosLocal.abortController){ try{sonosLocal.abortController.abort();}catch{} }
    const controller=new AbortController();
    sonosLocal.abortController=controller;
    if(force){ setSonosStatus('Opdaterer Sonos‚Ä¶'); }
    try{
      const res=await fetch(url,{signal:controller.signal,cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json();
      if(controller.signal.aborted) return;
      hideSonosNotice();
      sonosLocal.state=data||{};
      if(!sonosLocal.currentGroupId && data?.groups?.length){
        const last=config.sonosLocal?.lastGroupId;
        const match=data.groups.find(g=>g.id===last) || data.groups[0];
        if(match){ sonosLocal.currentGroupId=match.id; }
      }
      renderSonosState();
      setSonosStatus('Sidst opdateret '+nowStr());
      scheduleSonosPoll();
    }catch(err){
      if(controller.signal.aborted) return;
      cancelSonosPoll();
      console.error('[sonos-local]',err);
      sonosLocal.state=null;
      resetSonosUi();
      setSonosStatus('Ikke forbundet');
      showSonosNotice(sonosLocalBase(), err.message||'Ingen forbindelse');
    }
  }
  function openSonosLocal(){
    if(!config.sonosLocal?.enabled || !sonosDom.view) return false;
    hidePanel();
    sonosDom.view.removeAttribute('hidden');
    sonosDom.view.setAttribute('aria-hidden','false');
    setSonosStatus('Forbinder til Sonos‚Ä¶');
    hideSonosNotice();
    resetSonosUi();
    sonosLocal.currentGroupId=config.sonosLocal?.lastGroupId||'';
    sonosLocalRefresh(true);
    return true;
  }
  function closeSonosLocal(){
    if(!sonosDom.view) return;
    cancelSonosPoll();
    if(sonosLocal.abortController){ try{sonosLocal.abortController.abort();}catch{} sonosLocal.abortController=null; }
    sonosDom.view.setAttribute('hidden','');
    sonosDom.view.setAttribute('aria-hidden','true');
  }
  async function sendSonosCommand(action,payload={}){
    if(!sonosLocal.currentGroupId) return;
    const url=sonosLocalUrl('/api/groups/'+encodeURIComponent(sonosLocal.currentGroupId)+'/command');
    if(!url) return;
    try{
      await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.assign({action},payload))});
      setTimeout(()=>sonosLocalRefresh(true),300);
    }catch(err){
      console.error('[sonos-local-command]',err);
      showSonosNotice(sonosLocalBase(),'Kunne ikke sende kommando: '+(err.message||'ukendt fejl'));
      setSonosStatus('Fejl ved kommando');
    }
  }
  on($('closeSonos'),'click',closeSonosLocal);
  if(sonosDom.reload){ on(sonosDom.reload,'click',()=>sonosLocalRefresh(true)); }
  if(sonosDom.openWeb){ on(sonosDom.openWeb,'click',()=>openSonosStandalone((config.sonosUrl||'').trim()||'https://play.sonos.com')); }
  if(sonosDom.volume){
    on(sonosDom.volume,'input',function(){ sonosDom.volumeValue.textContent=this.value+'%'; });
    on(sonosDom.volume,'change',function(){ sendSonosCommand('setVolume',{volume:Number(this.value)}); });
  }
  if(sonosDom.playPause){ on(sonosDom.playPause,'click',()=>sendSonosCommand((sonosLocal.state?.groups||[]).find(g=>g.id===sonosLocal.currentGroupId)?.isPlaying?'pause':'play')); }
  if(sonosDom.prev){ on(sonosDom.prev,'click',()=>sendSonosCommand('previous')); }
  if(sonosDom.next){ on(sonosDom.next,'click',()=>sendSonosCommand('next')); }
  if(sonosDom.muteToggle){ on(sonosDom.muteToggle,'click',()=>sendSonosCommand((sonosLocal.state?.groups||[]).find(g=>g.id===sonosLocal.currentGroupId)?.muted?'unmute':'mute')); }

  /* Webpanel (Homey/Sonos) */
  const WK_IFRAME_SANDBOX_DEFAULT='allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox';
  const WK_IFRAME_SANDBOX_SONOS=WK_IFRAME_SANDBOX_DEFAULT+' allow-modals allow-top-navigation allow-top-navigation-by-user-activation allow-storage-access-by-user-activation';
  const WK_IFRAME_ALLOW_DEFAULT='autoplay; fullscreen; picture-in-picture';
  const WK_IFRAME_ALLOW_SONOS=WK_IFRAME_ALLOW_DEFAULT+'; encrypted-media; clipboard-write; geolocation; microphone; camera';
  const SONOS_HOST_RE=/(?:^|\.)sonos(?:-radio)?\.com$/i;

  function isSonosUrl(url){
    try{
      const host=new URL(url,location.href).hostname;
      return SONOS_HOST_RE.test(host);
    }catch(_){
      return false;
    }
  }

  function openSonosStandalone(link){
    try{
      const here=new URL(location.href);
      const launcher=new URL('./sonos_launcher.html',here);
      if(link) launcher.searchParams.set('target',link);
      launcher.searchParams.set('return',here.pathname+here.search);
      const hid=here.searchParams.get('hid');
      if(hid) launcher.searchParams.set('hid',hid);
      location.href=launcher.toString();
    }catch(_){
      location.href=link||'https://play.sonos.com';
    }
  }

  let panelLoadTimer=null;
  let sonosFetchAbort=null;

  function configureFrameFor(url,profile){
    const frame=$('wkFrame');
    if(!frame) return;
    let host='';
    try{host=new URL(url,location.href).hostname;}catch{}
    const effectiveProfile=profile|| (SONOS_HOST_RE.test(host)?'sonos':'default');
    const isSonos=effectiveProfile==='sonos';
    frame.setAttribute('sandbox',isSonos?WK_IFRAME_SANDBOX_SONOS:WK_IFRAME_SANDBOX_DEFAULT);
    frame.setAttribute('allow',isSonos?WK_IFRAME_ALLOW_SONOS:WK_IFRAME_ALLOW_DEFAULT);
    frame.dataset.profile=effectiveProfile;
  }
  function stopPanelWatch(){
    if(panelLoadTimer){clearTimeout(panelLoadTimer);panelLoadTimer=null;}
  }
  function watchPanelLoad(url,title,profile){
    const frame=$('wkFrame');
    const blocked=$('wkBlocked');
    if(!frame)return;
    stopPanelWatch();
    frame.dataset.loading='1';
    if(blocked){blocked.dataset.url=url;blocked.setAttribute('hidden','');}
    const handle=()=>{
      frame.dataset.loading='0';
      stopPanelWatch();
      if(blocked){blocked.setAttribute('hidden','');blocked.dataset.url=url;}
    };
    frame.addEventListener('load',handle,{once:true});
    const host=(()=>{try{return new URL(url,location.href).hostname;}catch{return '';}})();
    const isSonos=(profile==='sonos')||SONOS_HOST_RE.test(host);
    const waitMs=isSonos?12000:4500;
    panelLoadTimer=setTimeout(()=>{
      if(frame.dataset.loading==='1' && $('wkPanel') && !$('wkPanel').hasAttribute('hidden')){
        showBlocked(url,title,profile);
      }
    },waitMs);
  }
  function showPanel(url,title,options={}){
    const requestUrl=options.displayUrl||url;
    const label=title||requestUrl;
    $('wkTitle').textContent=label;
    const frame=$('wkFrame');
    const panel=$('wkPanel');
    const blocked=$('wkBlocked');
    if(blocked){blocked.dataset.url='';blocked.dataset.profile='';blocked.setAttribute('hidden','');}
    if(frame){
      if(frame._releaseFn){try{frame._releaseFn();}catch{} frame._releaseFn=null;}
      configureFrameFor(requestUrl,options.profile);
      frame.dataset.requestUrl=requestUrl;
      frame.dataset.requestTitle=label;
      frame.dataset.requestProfile=options.profile||'';
      try{frame.src='about:blank';}catch{}
      if(options.release){frame._releaseFn=options.release;}
      if(options.skipWatch){
        stopPanelWatch();
        frame.dataset.loading='0';
        frame.src=url;
      }else{
        watchPanelLoad(requestUrl,label,options.profile);
        frame.src=url;
      }
    }
    if(panel){panel.removeAttribute('hidden');panel.setAttribute('aria-hidden','false');}
  }
  function hidePanel(){
    const panel=$('wkPanel');
    const frame=$('wkFrame');
    const blocked=$('wkBlocked');
    stopPanelWatch();
    if(sonosFetchAbort){try{sonosFetchAbort.abort();}catch{} sonosFetchAbort=null;}
    if(frame){
      if(frame._releaseFn){try{frame._releaseFn();}catch{} frame._releaseFn=null;}
      frame.src='about:blank';
      frame.dataset.loading='0';
      frame.setAttribute('sandbox',WK_IFRAME_SANDBOX_DEFAULT);
      frame.setAttribute('allow',WK_IFRAME_ALLOW_DEFAULT);
      frame.dataset.profile='default';
      frame.dataset.requestUrl='';
      frame.dataset.requestTitle='';
      frame.dataset.requestProfile='';
    }
    if(blocked){blocked.dataset.url='';blocked.dataset.profile='';blocked.setAttribute('hidden','');}
    if(panel){panel.setAttribute('hidden','');panel.setAttribute('aria-hidden','true');}
  }
  on($('wkBack'),'click',hidePanel);
  on($('wkBlockedClose'),'click',hidePanel);
  on($('wkBlockedOpen'),'click',()=>{
    const blocked=$('wkBlocked');
    const target=blocked&&blocked.dataset?blocked.dataset.url:'';
    const profile=blocked&&blocked.dataset?blocked.dataset.profile||'':'';
    hidePanel();
    if(profile==='sonos' && target){
      openSonosStandalone(target);
      return;
    }
    if(target){
      if(isSonosUrl(target)){
        openSonosStandalone(target);
        return;
      }
      const opened=window.open(target,'_blank','noopener');
      if(!opened){location.href=target;}
    }
  });

  function showBlocked(url,title,profile){
    stopPanelWatch();
    const hostLabel=$('wkBlockedHost');
    if(hostLabel){
      try{hostLabel.textContent=new URL(url,location.href).hostname;}catch{hostLabel.textContent=url;}
    }
    const hint=$('wkBlockedHint');
    if(hint){
      if(profile==='sonos'){
        hint.textContent='Sonos tillader ikke indlejring i en webvisning, s√• vi √•bner den i en ny fane i stedet.';
      }else{
        hint.textContent='Siden kan v√¶re blokeret for indlejring. √Öbn den evt. direkte i en ny fane.';
      }
    }
    const blocked=$('wkBlocked');
    if(blocked){blocked.dataset.url=url;blocked.dataset.profile=profile||'';blocked.removeAttribute('hidden');}
    $('wkTitle').textContent=title||url;
    const panel=$('wkPanel');
    if(panel){panel.removeAttribute('hidden');panel.setAttribute('aria-hidden','false');}
    const frame=$('wkFrame');
    if(frame){
      if(frame._releaseFn){try{frame._releaseFn();}catch{} frame._releaseFn=null;}
      frame.src='about:blank';
      frame.dataset.loading='blocked';
    }
  }

  function prepareSonosDocument(html,url){
    try{
      const targetUrl=new URL(url,location.href);
      const baseHref=new URL('.',targetUrl).href;
      let doc=html.replace(/<meta[^>]+http-equiv=["']?Content-Security-Policy["']?[^>]*>/gi,'');
      doc=doc.replace(/<base[^>]*>/gi,'');
      const baseTag=`<base href="${baseHref}">`;
      const styleTag='<style>html,body{height:100%;margin:0;background:#000;}body{overflow:hidden;}</style>';
      if(/<head[^>]*>/i.test(doc)){
        doc=doc.replace(/<head([^>]*)>/i,`<head$1>${baseTag}${styleTag}`);
      }else{
        doc=`${baseTag}${styleTag}`+doc;
      }
      return doc;
    }catch(err){
      console.error('[sonos] prepare failed',err);
      return html;
    }
  }

  async function openSonosEmbedded(target){
    if(!target){openSonosStandalone('https://play.sonos.com');return;}
    if(sonosFetchAbort){try{sonosFetchAbort.abort();}catch{} sonosFetchAbort=null;}
    const controller=new AbortController();
    sonosFetchAbort=controller;
    showPanel('about:blank','Indl√¶ser Sonos‚Ä¶',{profile:'sonos',displayUrl:target,skipWatch:true});
    const frame=$('wkFrame');
    if(frame){
      frame.dataset.loading='fetch';
    }
    let timedOut=false;
    let timeoutId=null;
    try{
      timeoutId=setTimeout(()=>{timedOut=true;try{controller.abort();}catch{}},15000);
      const res=await fetch(target,{credentials:'include',mode:'cors',signal:controller.signal});
      clearTimeout(timeoutId);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text=await res.text();
      if(controller.signal.aborted) return;
      if(!text||text.length<200){throw new Error('Empty Sonos response');}
      const prepared=prepareSonosDocument(text,target);
      const blob=new Blob([prepared],{type:'text/html'});
      const blobUrl=URL.createObjectURL(blob);
      const release=()=>{URL.revokeObjectURL(blobUrl);};
      sonosFetchAbort=null;
      showPanel(blobUrl,'Sonos',{profile:'sonos',displayUrl:target,release});
    }catch(err){
      clearTimeout(timeoutId);
      if(sonosFetchAbort===controller){sonosFetchAbort=null;}
      if(controller.signal.aborted){
        if(timedOut){
          console.error('[sonos] embed timeout',err);
          hidePanel();
          openSonosStandalone(target);
        }
        return;
      }
      sonosFetchAbort=null;
      console.error('[sonos] embed failed',err);
      hidePanel();
      openSonosStandalone(target);
    }
  }

  function openHomey(){
    const u=(config.homeyUrl||'').trim();
    if(!u){alert('Ingen Homey URL.');return;}
    if(/^https?:\/\//i.test(u))showPanel(u,'Homey');else location.href=u;
  }
  function openSonos(){
    if(config.sonosLocal?.enabled && openSonosLocal()){
      return;
    }
    const isAndroid=/Android/i.test(navigator.userAgent), isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);
    const pkg=(config.sonosPkg||'').trim()||'com.sonos.acr2';
    const scheme=(config.sonosScheme||config.sonosUrl||'').trim();
    if(isiOS && /^sonos:\/\//i.test(scheme)){location.href=scheme;return;}
    if(isAndroid && pkg){const fb=encodeURIComponent(location.href);location.href='intent://open/#Intent;package='+pkg+';S.browser_fallback_url='+fb+';end;';setTimeout(()=>{location.href='market://details?id='+pkg;},1200);return;}
    const link=(config.sonosUrl||'').trim()||'https://play.sonos.com';
    if(/^https?:\/\//i.test(link)){
      if(isSonosUrl(link)){
        openSonosEmbedded(link);
      }else{
        showPanel(link,'Sonos');
      }
    }else{
      window.open(link,'_self');
    }
  }
  window.__handlers.openHomey=openHomey; window.__handlers.openSonos=openSonos;

  /* NoSleep */
  let noSleep=null; window.addEventListener('click',()=>{try{if(config.keepAwake&&!noSleep&&window.NoSleep){noSleep=new NoSleep();noSleep.enable();}}catch{}});

  /* Firebase (anon + Firestore) */
  const firebaseConfig = {
    apiKey: "AIzaSyA_gh8y-V6kkl95hRzb0ldBxpKWFY5bAck",
    authDomain: "webkiosk-e5d32.firebaseapp.com",
    projectId: "webkiosk-e5d32",
    storageBucket: "webkiosk-e5d32.firebasestorage.app",
    messagingSenderId: "920175197353",
    appId: "1:920175197353:web:c3520e9a3ab8146ec4fdb8",
    measurementId: "G-X6LHDEPS8H"
  };
  const fb=firebase.initializeApp(firebaseConfig), auth=firebase.auth(), db=firebase.firestore();

  function badge(state,note){const b=$('syncBadge'),t=$('syncBadgeText'),n=$('syncBadgeNote');['sync-online','sync-syncing','sync-offline','sync-error'].forEach(c=>b.classList.remove(c));b.classList.add('sync-'+state);t.textContent={online:'Online',syncing:'Synkroniserer‚Ä¶',offline:'Offline',error:'Fejl'}[state]||'Offline';n.textContent=note?('¬∑ '+note):'';$('syncNote')&&($('syncNote').textContent=t.textContent+(note?(' '+note):''));$('lastSync')&&($('lastSync').textContent=note||'‚Äî');}
  window.addEventListener('online',()=>badge('online',nowStr())); window.addEventListener('offline',()=>badge('offline',''));
  auth.signInAnonymously().then(()=>badge(navigator.onLine?'online':'offline',nowStr())).catch(e=>{console.error('[auth]',e);badge('error','auth');});

  let unsub=null, writeTimer=null;
  const docRef=()=>db.collection('webkiosk').doc((config.householdId||'DEFAULT').toUpperCase());
  async function writeFirestore(){
    try{
      const toSave=JSON.parse(JSON.stringify(config));
      toSave.logos={}; if(toSave.calendar) toSave.calendar.fileData='';
      toSave._ts=Date.now(); save(Object.assign(config,{_ts:toSave._ts}));
      await docRef().set(toSave,{merge:true}); badge('online',nowStr());
    }catch(e){console.error('[write]',e);badge('error',e.code||e.message||'write');}
  }
  function queueWriteFirestore(){if(writeTimer)clearTimeout(writeTimer);badge('syncing','‚Ä¶');writeTimer=setTimeout(writeFirestore,300);}
  function startRealtime(){
    try{
      if(unsub)unsub();
      unsub=docRef().onSnapshot(s=>{
        if(!s||!s.exists) return;
        const r=s.data()||{}, l=load();
        if(r._ts && (!l._ts || r._ts>l._ts)){ config=Object.assign({},l,r); save(config); applyAll(); }
      }, e=>{console.error('[listen]',e);badge('error',e.code||'snapshot');});
    }catch(e){console.error('[listen-outer]',e);badge('error','listen');}
  }
  startRealtime();
  </script>
</body>
</html>
