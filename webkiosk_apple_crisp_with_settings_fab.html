<!-- File: webkiosk_REBUILD_SAFE.html (kan også bruges som erstatning for webkiosk_apple_crisp_with_settings_fab.html) -->
<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Webkiosk</title>
  <meta name="theme-color" content="#0f172a"/>
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--bg:#f6f7fb;--card:#fff;--radius:16px;--shadow:0 10px 30px rgba(2,6,23,.08);}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .tiles{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;margin-top:14px}
    .tile{background:#fff;border-radius:14px;border:1px solid #e5e7eb;box-shadow:0 6px 18px rgba(2,6,23,.06);padding:16px;cursor:pointer}
    .tile h4{margin:0 0 4px 0}
    .fab{position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:999px;background:#0f172a;color:#fff;border:none;box-shadow:0 10px 30px rgba(2,6,23,.2);font-size:22px;cursor:pointer}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700;color:#334155}
    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,.28);display:none;align-items:flex-start;justify-content:center;padding:26px;z-index:2000}
    .modal{width:min(860px,92vw);max-height:min(92vh,92dvh);overflow:auto;background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .row{display:grid;grid-template-columns:200px 1fr;gap:12px;align-items:center}
    label{font-weight:800;color:#334155}
    input[type="text"],input[type="url"],input[type="color"]{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font:inherit;background:#fff}
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    .btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn.primary{background:#0f172a;color:#fff;border-color:transparent}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .chip{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-weight:700;background:#fff;cursor:pointer}
    .chip.active{background:#0f172a;color:#fff;border-color:transparent}
    .hid{font-weight:800;margin-left:8px}
    .muted{color:#64748b}
    .debug{position:fixed;left:12px;bottom:12px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font:12px ui-sans-serif;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div style="font-size:22px;font-weight:800">Webkiosk</div>
      <div><span class="badge">HID: <span id="hidBadge">—</span></span></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="muted" style="font-weight:800;margin-bottom:6px">Vejr</div>
        <div id="weather">—</div>
      </div>
      <div class="card">
        <div class="muted" style="font-weight:800;margin-bottom:6px">Ur</div>
        <div id="clock" style="font-size:46px;font-weight:800">—</div>
        <div class="muted" id="clockSub">—</div>
      </div>
    </div>

    <div class="tiles">
      <div class="tile" id="btnCalendar"><h4>Kalender</h4><div class="muted">Familieoversigt</div></div>
      <div class="tile" id="btnHomey"><h4>Homey</h4><div class="muted">Dashboard</div></div>
      <div class="tile" id="btnSonos"><h4>Sonos</h4><div class="muted">App eller web</div></div>
    </div>
  </div>

  <button class="fab" id="openSettings" title="Indstillinger">⚙️</button>

  <!-- Settings modal -->
  <div class="backdrop" id="settingsBackdrop" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:800;font-size:18px">Indstillinger</div>
        <button class="btn" id="closeSettings">Luk</button>
      </div>

      <div class="tabbar">
        <button class="chip active" data-tab="look">Udseende</button>
        <button class="chip" data-tab="inputs">Indgange</button>
        <button class="chip" data-tab="sync">Synkronisering</button>
        <button class="chip" data-tab="screen">Skærm</button>
      </div>

      <div id="tab-look">
        <div class="row"><label for="theColor">Primær farve</label><input id="theColor" type="color" value="#0f172a"/></div>
        <div class="row"><label for="bgcolor">Baggrund</label><input id="bgcolor" type="color" value="#f6f7fb"/></div>
      </div>

      <div id="tab-inputs" style="display:none">
        <div class="row"><label>Kalender-mode</label>
          <div>
            <label><input type="radio" name="calendarMode" value="url" checked> URL</label>
            <label style="margin-left:16px"><input type="radio" name="calendarMode" value="upload"> Upload</label>
          </div>
        </div>
        <div class="row" id="calendarUploadRow" style="display:none">
          <label for="calendarFile">Kalender (upload)</label>
          <input id="calendarFile" type="file" accept=".html,.htm"/>
        </div>
        <div class="row">
          <label for="calendarUrl">Kalender URL</label>
          <input id="calendarUrl" type="url" placeholder="https://…/familieoversigt_index_v11_autosync_READY_UPDATED.html"/>
        </div>
        <div class="row"><label for="homeyUrl">Homey URL</label><input id="homeyUrl" type="url" placeholder="https://…"/></div>
        <div class="row"><label for="sonosUrl">Sonos URL</label><input id="sonosUrl" type="url" placeholder="https://account.sonos.com …"/></div>
      </div>

      <div id="tab-sync" style="display:none">
        <div class="row"><label>Husstands-ID</label><div><span class="badge" id="hidBadge2">—</span></div></div>
        <div class="row"><label>Status</label><div id="syncStatus" class="muted">—</div></div>
      </div>

      <div id="tab-screen" style="display:none">
        <div class="row"><label for="wake">Hold skærm vågen</label><div><label><input id="wake" type="checkbox"> Aktivér</label></div></div>
      </div>

      <div class="actions">
        <button class="btn primary" id="saveSettings">Gem</button>
      </div>
    </div>
  </div>

  <div class="debug" id="fsdebugBox">FS: —</div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    /* ======= Utils / state ======= */
    const QP = new URLSearchParams(location.search);
    const HID = (QP.get("hid") || "DEFAULT").toUpperCase();
    const FSDEBUG = QP.get("fsdebug")==="1";
    const hidBadge = document.getElementById('hidBadge');
    const hidBadge2 = document.getElementById('hidBadge2');
    hidBadge.textContent = HID; hidBadge2.textContent = HID;

    const CFG_KEY = "wk_config";
    function loadConfig(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY) || "{}"); }catch(_){ return {}; } }
    function saveConfig(cfg){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg||{})); }

    /* ======= Firebase ======= */
    const firebaseConfig = {
      apiKey: "AIzaSyA_gh8y-V6kkl95hRzb0ldBxpKWFY5bAck",
      authDomain: "webkiosk-e5d32.firebaseapp.com",
      projectId: "webkiosk-e5d32",
      storageBucket: "webkiosk-e5d32.firebasestorage.app",
      messagingSenderId: "920175197353",
      appId: "1:920175197353:web:c3520e9a3ab8146ec4fdb8"
    };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ======= UI: clock/weather (enkel) ======= */
    function tick(){ const d=new Date();
      const d2 = d.toLocaleDateString('da-DK',{weekday:'long',day:'2-digit',month:'long'});
      document.getElementById('clock').textContent =
        String(d.getHours()).padStart(2,'0')+":" + String(d.getMinutes()).padStart(2,'0');
      document.getElementById('clockSub').textContent = d2;
    }
    setInterval(tick,1000); tick();
    document.getElementById('weather').textContent = "—"; // (din eksisterende vejr-kode kan stå her)

    /* ======= Settings modal ======= */
    const $backdrop = document.getElementById('settingsBackdrop');
    document.getElementById('openSettings').onclick = ()=>{ $backdrop.style.display='flex'; };
    document.getElementById('closeSettings').onclick = ()=>{ $backdrop.style.display='none'; };

    // Tabs
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        const t = ch.getAttribute('data-tab');
        ['look','inputs','sync','screen'].forEach(id=>{
          document.getElementById('tab-'+id).style.display = (id===t)?'':'none';
        });
      });
    });

    // Apply form from config
    function applyForm(){
      const cfg = loadConfig();
      // farver
      document.getElementById('theColor').value = cfg?.theme?.color || '#0f172a';
      document.getElementById('bgcolor').value  = cfg?.theme?.background || '#f6f7fb';
      // kalender
      const mode = cfg?.calendar?.mode || 'url';
      document.querySelectorAll('input[name="calendarMode"]').forEach(r=>{
        r.checked = (r.value===mode);
      });
      document.getElementById('calendarUploadRow').style.display = mode==='upload' ? '' : 'none';
      // urls
      document.getElementById('calendarUrl').value = cfg?.links?.calendar || '';
      document.getElementById('homeyUrl').value    = cfg?.links?.homey || '';
      document.getElementById('sonosUrl').value    = cfg?.links?.sonos || '';
      // skærm
      document.getElementById('wake').checked = !!cfg?.screen?.wakelock;
    }
    function applyTheme(){
      const cfg = loadConfig();
      document.documentElement.style.setProperty('--bg', cfg?.theme?.background || '#f6f7fb');
      document.documentElement.style.setProperty('--ink', cfg?.theme?.color || '#0f172a');
    }
    function applyAllFromConfig(){ applyTheme(); applyForm(); }

    /* ======= Persist form to config ======= */
    document.getElementById('saveSettings').addEventListener('click', ()=>{
      const cfg = loadConfig();
      cfg.theme = cfg.theme || {};
      cfg.theme.color = document.getElementById('theColor').value;
      cfg.theme.background = document.getElementById('bgcolor').value;

      cfg.calendar = cfg.calendar || {};
      cfg.calendar.mode = Array.from(document.querySelectorAll('input[name="calendarMode"]'))
        .find(r=>r.checked)?.value || 'url';

      cfg.links = cfg.links || {};
      cfg.links.calendar = document.getElementById('calendarUrl').value.trim();
      cfg.links.homey    = document.getElementById('homeyUrl').value.trim();
      cfg.links.sonos    = document.getElementById('sonosUrl').value.trim();

      cfg.screen = cfg.screen || {};
      cfg.screen.wakelock = document.getElementById('wake').checked;

      saveConfig(cfg);
      applyAllFromConfig();
      queueWriteFirestore();              // <- vigtig: synk til Firestore
      $backdrop.style.display = 'none';
    });

    // Reager live på inputs (for konsistens) – især kalenderMode
    [].slice.call(document.querySelectorAll('input[name="calendarMode"]')).forEach(r=>{
      r.addEventListener('change', ()=>{
        const cfg = loadConfig(); cfg.calendar = cfg.calendar || {};
        cfg.calendar.mode = r.value; saveConfig(cfg);
        document.getElementById('calendarUploadRow').style.display = (r.value==='upload')?'':'none';
        queueWriteFirestore();            // <- vigtig: debounce write
      });
    });
    // Farver
    ['theColor','bgcolor'].forEach(id=>{
      document.getElementById(id).addEventListener('change', ()=>{
        const cfg = loadConfig(); cfg.theme = cfg.theme || {};
        if(id==='theColor') cfg.theme.color = document.getElementById(id).value;
        if(id==='bgcolor')  cfg.theme.background = document.getElementById(id).value;
        saveConfig(cfg); applyTheme(); queueWriteFirestore();
      });
    });

    /* ======= Wake lock (skærm) ======= */
    let wakeLock = null;
    async function ensureWakeLock(on){ try{
      if(on && 'wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); }
      else if(wakeLock){ await wakeLock.release(); wakeLock=null; }
    }catch(_){/* stille fejl */} }
    document.getElementById('wake').addEventListener('change', (e)=>{
      const cfg = loadConfig(); cfg.screen=cfg.screen||{}; cfg.screen.wakelock=!!e.target.checked;
      saveConfig(cfg); ensureWakeLock(cfg.screen.wakelock); queueWriteFirestore();
    });

    /* ======= Open tiles ======= */
    function openUrl(u){ if(!u){ alert('Manglende URL i Indstillinger'); return; } location.href = u; }
    document.getElementById('btnCalendar').onclick = ()=> openUrl(loadConfig()?.links?.calendar);
    document.getElementById('btnHomey').onclick    = ()=> openUrl(loadConfig()?.links?.homey);
    document.getElementById('btnSonos').onclick    = ()=> openUrl(loadConfig()?.links?.sonos);

    /* ======= Firestore sync for settings (debounced write + live read) ======= */
    const DEVICE_ID = (localStorage.getItem('fs_device_id') || (()=>{
      const id = (crypto.randomUUID?crypto.randomUUID():('d-'+Date.now().toString(36)+Math.random().toString(36).slice(2)));
      localStorage.setItem('fs_device_id', id); return id;
    })());
    const metaDoc = db.collection('households').doc(HID).collection('calendar').doc('v1').collection('meta').doc('config');

    let lastWriteAt = 0, pending=false, timer=null;
    const WRITE_DEBOUNCE_MS = 1200, WRITE_MIN_GAP_MS = 2000;

    function queueWriteFirestore(){
      pending = true; clearTimeout(timer);
      timer = setTimeout(tryWrite, WRITE_DEBOUNCE_MS);
    }
    async function tryWrite(){
      if(!pending) return;
      const now = Date.now();
      if(now - lastWriteAt < WRITE_MIN_GAP_MS){
        timer = setTimeout(tryWrite, WRITE_MIN_GAP_MS - (now-lastWriteAt));
        return;
      }
      pending=false; lastWriteAt=now;
      try{
        const cfg = loadConfig() || {};
        await metaDoc.set({
          config: cfg,
          _deviceId: DEVICE_ID,
          _updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        setSyncStatus('skrevet ✔︎');
      }catch(e){ setSyncStatus('fejl'); console.warn('[FS] write fejl', e); }
    }

    function setSyncStatus(t){ const el=document.getElementById('syncStatus'); if(el) el.textContent=t; }

    function startConfigListener(){
      metaDoc.onSnapshot({includeMetadataChanges:true}, (snap)=>{
        if(!snap.exists) return;
        const d = snap.data() || {};
        // ignorér egne pending writes
        if(d._deviceId===DEVICE_ID && snap.metadata.hasPendingWrites) return;
        if(d.config){
          saveConfig(d.config);
          applyAllFromConfig();
          setSyncStatus('online');
        }
      }, (err)=>{ setSyncStatus('fejl'); console.warn('[FS] onSnapshot', err); });
    }

    /* ======= Start ======= */
    firebase.auth().signInAnonymously()
      .then(()=>{ startConfigListener(); applyAllFromConfig();
                  ensureWakeLock(loadConfig()?.screen?.wakelock); })
      .catch(e=> console.error('Auth fejl', e));

    // FS debug badge
    if(FSDEBUG){
      const box=document.getElementById('fsdebugBox'); box.style.display='block';
      db.collection('households').doc(HID).collection('calendar').doc('v1').collection('items')
        .onSnapshot(s=>{ box.textContent = `FS: ${HID} · ${s.size} docs`; },
                    e=>{ box.textContent = `FS err: ${e.message}`; });
    }
  })();
  </script>
</body>
</html>
